<script>
	import * as api from 'api.js';
	import { stores } from '@sapper/app';
	import { videos } from '../../stores/videoStore';
	import List, { Item, Graphic, Meta, Separator, Subheader, Text, PrimaryText, SecondaryText } from '@smui/list';
	import SimpleVideoCard from './_SimpleVideoCard.svelte';

	export let selectionUserId;
	export {users as $users};

	const { session } = stores();
	
	let _userVideos;
	let users = [];
	let ids = [];

	$: user = $session.user;
	$: currentUserIndex = (typeof selectionUserId === 'number') && (id => users.findIndex(usr => usr.id === id))(selectionUserId);
	$: userVideos = $videos && getUserVideos(currentUserIndex); // make reactive in case video store has changed
	$: noneUserVideos = $videos.filter( vid => !userVideos.find( uv => vid.id === uv.id ));

    function getUserVideos(idx) {
		let videos;
		if(users[idx] && (videos = users[idx].videos)) return videos;
		return [];
	}

	function setUserVideos(idx, videos) {
		userVideos = videos.slice();
		users[idx] && (users[idx].videos = videos);
	}

	function getUserVideoIds(video) {
		let index;
		if(-1 !== (index = userVideos.findIndex(itm=>itm.id === video.id))) {
			// remove
			_userVideos = [...userVideos.slice(0, index), ...userVideos.slice(index + 1)]
		} else {
			// add
			_userVideos = [...userVideos, video];
		}
		ids = _userVideos.map(v=>v.id);
		
		return ids;
	}

	async function videoSelectedHandler(e) {

		let video = e.detail;
		let ids = getUserVideoIds(video);
		let data = { 'videos': {'_ids': [...ids]} };
		
		const res = await api.put(`users/${selectionUserId}`, data, user && user.token);
		if(res.success) {
			setUserVideos(currentUserIndex, _userVideos);
		}
    }
	
</script>

<style>
    .grid-item {
        background: var(--back-grid-item);
	}
    .user-videos {
        grid-area: one;
    }
    .videos {
        grid-area: two;
	}
	.no-user-selected, .no-videos {
		display: flex;
		justify-content: center;
		align-items: center;
	}
	.no-user {
		display: block;
	}
</style>
<div class="grid-item user-videos" class:no-user-selected={!selectionUserId} class:no-videos={!userVideos.length}>
	{#if selectionUserId}
		{#if userVideos.length}
			<List class="video-list" twoLine avatarList singleSelection>
				{#each userVideos as video (video.id)}
					<SimpleVideoCard
						class="user-video"
						check
						on:videoSelected={videoSelectedHandler}
						on:videoSelected
						{video}
						{selectionUserId}
					/>
				{/each}
			</List>
		{:else}
			<div class="user-video">User has no Videos</div>
		{/if}
	{:else}
		<div class="no-user">
			No User Selected
		</div>
	{/if}
</div>
<div class="grid-item videos">
	<List class="demo-list" twoLine avatarList singleSelection>
		{#each noneUserVideos as video (video.id)}
			<SimpleVideoCard
				class="video"
				on:videoSelected={videoSelectedHandler}
				{video}
				{selectionUserId}
			/>
		{/each}
	</List>
</div>