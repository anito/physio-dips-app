<script>
  import { stores, goto } from "@sapper/app";
  import { getContext } from "svelte";
  import { fly } from "svelte/transition";
  import Paper, { Title, Subtitle, Content } from "@smui/paper";
  import Fab, { Label, Icon } from "@smui/fab";
  import MediaUploader from "./_MediaUploader.svelte";
  import VideoCard from "./_VideoCard.svelte";
  import Info from "./_Info.svelte";
  import { videos } from "../../stores/videoStore";
  import { images } from "../../stores/imageStore";
  import { currentVideo } from "../../stores/currentVideoStore";

  const { open } = getContext("simple-modal");

  let { session } = stores();

  let openUploader = (type) => {
    open(
      MediaUploader,
      {
        type,
        options: {
          // acceptedFiles: '.mov .mp4 .m4a .m4v .3gp .3g2 .webm',
          uploadMultiple: true,
          parallelUploads: 20,
          maxFiles: 20,
        },
        events: { uploadDone },
      },
      {
        transitionWindow: fly,
        transitionWindowProps: {
          y: -200,
          duration: 500,
        },
      }
    );
  };

  function uploadDone(e) {
    let data = e.detail;
    videos.add(data);

    let video;
    if (!(video = $currentVideo)) return;

    // take the last element for our poster
    let image_id = data.slice(-1)[0].id;
    video.image_id = image_id;

    videoEmitter.dispatch({
      method: "put",
      data: video,
    });
  }

  function setCurrentVideo(e) {
    currentVideo.set(e.detail);
  }
</script>

<div class="lg:m-8">
  {#if $session.user}
    {#if $videos.length}
      <div class="flex flex-wrap flex-row lg:justify-start justify-center">
        {#each $videos as video (video.id)}
          <div class="flex mx-1 my-2">
            <div>
              <VideoCard on:Video:current={setCurrentVideo} {video} {images} />
            </div>
          </div>
        {/each}
      </div>
    {:else}
      <div class="paper-container flex justify-center">
        <Paper color="primary" class="paper-demo">
          <Title style="color: var(--text-light)">No Videos available</Title>
        </Paper>
      </div>
    {/if}
    {#if $session.role === 'Administrator'}
      <Fab
        class="floating-fab"
        color="primary"
        on:click={() => openUploader('video')}
        extended>
        <Label>Neues Video</Label>
        <Icon class="material-icons">add</Icon>
      </Fab>
    {/if}
  {:else}
    <div class="paper-container flex justify-center m-8">
      <Info title="Unauthorized" let:href>
        <a {href} on:click|preventDefault={() => goto(href)}>Login</a>
      </Info>
    </div>
  {/if}
</div>
