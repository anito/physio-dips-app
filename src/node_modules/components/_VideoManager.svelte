<script>
  import * as api from "api.js";
  import { stores } from "@sapper/app";
  import "./button.scss";
  import Button, { Label, Icon } from "@smui/button";
  import List from "@smui/list";
  import SimpleVideoCard from "components/SimpleVideoCard";
  import { videos } from "../../stores/videoStore";
  import { users } from "../../stores/userStore";

  export let selectionUserId;

  const { session } = stores();

  let _userVideos;
  let ids = [];

  $: user = $session.user;
  $: currentUserIndex =
    typeof selectionUserId === "number" &&
    ((id, users) => users.findIndex((usr) => usr.id === id))(
      selectionUserId,
      $users
    );
  $: userVideos = $videos && getUserVideos(currentUserIndex); // make reactive in case video store has changed
  $: noneUserVideos = $videos.filter(
    (vid) => !userVideos.find((uv) => vid.id === uv.id)
  );
  $: console.log($users);

  function setUserVideos(idx, videos) {
    userVideos = videos.slice();
    $users[idx] && ($users[idx].videos = videos);
  }

  export function getUserVideos(idx) {
    let userVideos = [];
    let _videos = get(videos);
    let _users = get(users);
    if (_users[idx] && (userVideos = _users[idx].videos) && userVideos.length) {
      userVideos = _videos.filter((v) =>
        userVideos.find((uv) => uv.id === v.id)
      );
    }
    return userVideos;
  }

  function getUserVideoIds(video) {
    let idx;
    if (-1 !== (idx = userVideos.findIndex((itm) => itm.id === video.id))) {
      // remove
      _userVideos = [...userVideos.slice(0, idx), ...userVideos.slice(idx + 1)];
    } else {
      // add
      _userVideos = [...userVideos, video];
    }
    ids = _userVideos.map((v) => v.id);

    return ids;
  }

  async function toggle(video) {
    let ids = getUserVideoIds(video);

    // confirm remove dialoge
    if (
      ids.length < userVideos.length &&
      !confirm(`Remove Video "${video.title}" from Subscription?`)
    )
      return;

    let data = { videos: { _ids: [...ids] } };

    const res = await api.put(
      `users/${selectionUserId}`,
      data,
      user && user.token
    );

    if (res && res.success) {
      setUserVideos(currentUserIndex, _userVideos);
    }
    return false;
  }
</script>

<style>
  .grid-item {
    background: var(--back-grid-item);
  }
  .user-videos {
    grid-area: one;
    overflow: auto;
  }
  .videos {
    grid-area: two;
    overflow: auto;
  }
  .no-user-selected,
  .no-videos {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .no-user {
    display: block;
  }
</style>

<div
  class="grid-item user-videos"
  class:no-user-selected={!selectionUserId}
  class:no-videos={!userVideos.length}>
  {#if selectionUserId}
    {#if userVideos.length}
      <List class="user-video-list" twoLine avatarList singleSelection let:text>
        {#each userVideos as video (video.id)}
          <SimpleVideoCard
            class="user-video"
            emptyDateText="Not published"
            emphasizeEmptyDate
            {video}
            {selectionUserId}>
            <Button
              class="delete-action-button"
              on:click={(e) => toggle(video)}>
              <Icon class="material-icons">remove_circle_outline</Icon>
              <Label />
            </Button>
          </SimpleVideoCard>
        {/each}
      </List>
    {:else}
      <div class="user-video">User has no Videos</div>
    {/if}
  {:else}
    <div class="no-user">No User Selected</div>
  {/if}
</div>
<div class="grid-item videos" class:no-videos={!noneUserVideos.length}>
  <List class="video-list" twoLine avatarList singleSelection>
    {#if noneUserVideos.length}
      {#each noneUserVideos as video (video.id)}
        <SimpleVideoCard
          class="video"
          emptyDateText={video.description}
          {video}
          {selectionUserId}>
          <Button
            class="add-action-button"
            color="primary"
            on:click={(e) => toggle(video)}>
            <Icon class="material-icons">add_circle_outline</Icon>
            <Label />
          </Button>
        </SimpleVideoCard>
      {/each}
    {:else}
      <div class="user-video">No more videos available</div>
    {/if}
  </List>
</div>
