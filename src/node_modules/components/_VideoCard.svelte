<script>
  import * as api from "api.js";
  import "./button.scss";
  import { stores } from "@sapper/app";
  import { onDestroy, getContext, createEventDispatcher } from "svelte";
  import { fly } from "svelte/transition";
  import { videos } from "../../stores/videoStore";
  import { urls } from "../../stores/urlStore";
  import { videoEmitter } from "../../stores/videoEmitter";
  import { getMedia } from "utils";
  import VideoMedia from "./_VideoMedia.svelte";
  import MediaUploader from "./_MediaUploader.svelte";
  import Card, {
    Content,
    PrimaryAction,
    Actions,
    ActionButtons,
    ActionIcons,
  } from "@smui/card";
  import Button, { Label } from "@smui/button";
  import IconButton, { Icon } from "@smui/icon-button";
  import Menu from "@smui/menu";
  import MenuSurface, { Anchor } from "@smui/menu-surface";
  import ImageList, {
    Item as ImageListItem,
    ImageAspectContainer,
    Image,
  } from "@smui/image-list";
  import List, { Item, Separator, Text } from "@smui/list";
  import "./menu-surface.scss";

  export let video;
  export let images;
  export { className as class };

  const { open } = getContext("simple-modal");
  const { session } = stores();

  let user = $session.user;
  let className = "";
  let cardMenu;
  let deleteMenu;
  let dispatch = createEventDispatcher();
  let imageList;
  let imageListAnchor;
  let isEditMode = false;
  let title;
  let description;
  let dateOptions = {
    weekday: "long",
    year: "numeric",
    month: "2-digit",
    day: "numeric",
  };
  let isImageListOpen = false;

  $: leftButton = isEditMode
    ? { label: "Save", icon: "save" }
    : { label: "Edit", icon: "edit" };
  $: rightButton = isEditMode
    ? { label: "Cancel", icon: "cancel" }
    : { label: "Delete", icon: "delete" };
  $: matchingData =
    (video["_matchingData"] && video["_matchingData"]["UsersVideos"]) || null;
  $: canSave = description !== video.description || title !== video.title;

  onDestroy(() => {
    dispatch("Video:current", null);
  });

  function save() {
    video.title = title;
    video.description = description;
    videoEmitter.dispatch({
      method: "put",
      data: video,
    });
    isEditMode = false;
    return false;
  }

  function edit() {
    title = video.title || "";
    description = video.description || "";
    return true;
  }

  function setDeleteMenuOpen(bol) {
    deleteMenu.setOpen(bol);
    return false;
  }

  async function del() {
    let id = video.id;
    const res = await api.del(`videos/${id}`, user && user.token);

    if (res && res.success) {
      urls.del(id);
      videos.del(id);
    }
  }

  function selectPoster(id) {
    video.image_id = id;
    videoEmitter.dispatch({
      method: "put",
      data: video,
    });
  }

  function removePoster() {
    video.image_id = null;
    videoEmitter.dispatch({
      method: "put",
      data: video,
    });
  }

  function createPoster(type) {
    dispatch("Video:current", video);

    open(
      MediaUploader,
      {
        type,
        options: {
          uploadMultiple: false,
          parallelUploads: 1,
          maxFiles: 1,
        },
        events: { uploadDone },
      },
      {
        transitionWindow: fly,
        transitionWindowProps: {
          y: -200,
          duration: 500,
        },
      }
    );
  }

  function getCachedImage(id) {
    let res = getMedia("IMAGE", id, user, {
      width: 100,
      height: 100,
      square: 1,
    });
    return res;
  }

  function uploadDone(e) {
    let uploads = e.detail;
    let newPosterId = uploads.length && uploads[0].id;
    newPosterId && images.add(uploads), selectPoster(newPosterId);
  }

  function imageListOpenedHandler(e) {
    isImageListOpen = true;
  }

  function imageListClosedHandler(e) {
    isImageListOpen = false;
  }
</script>

<style>
  :global(.action-button) {
    min-width: 105px;
  }
  :global(.preview-image) {
    cursor: pointer;
  }
  .date-button :global(.square) {
    height: 100px;
    width: 100px;
    border-radius: 20px;
  }
</style>

<Card
  class="flex content-between card {className}"
  style="width: var(--player-w);">
  <PrimaryAction>
    <VideoMedia {video} bind:title bind:description {isEditMode} {user} />
    <Content class="mdc-typography--body2">
      {#if 'Administrator' === $session.role}
        <div class="text-xs text-inherit">
          <Icon class="material-icons">cloud_upload</Icon>
          <span>Created:</span>
          <span>{new Date(video.created).toLocaleDateString('de-DE', dateOptions)}</span>
        </div>
        <div
          class="opacity-25 text-xs text-inherit"
          class:opacity-25={!video.image_id}>
          <Icon class="material-icons">image</Icon>
          <span>Poster:</span>
          <span>{video.image_id || 'No Poster'}</span>
        </div>
      {:else}
        <div class="">
          <div class="flex justify-between">
            <Icon class="material-icons" style="align-self: center;">
              date_range
            </Icon>
            <Label style="align-self: center; padding-right: 20px;">
              You can view this content until:
            </Label>
            <div class="date-button">
              <Button
                color="primary"
                variant="unelevated"
                class="button-shaped-round square">
                <Label>
                  {new Date(matchingData.end).toLocaleDateString('de-DE', dateOptions)}
                </Label>
              </Button>
            </div>
          </div>
        </div>
      {/if}
    </Content>
  </PrimaryAction>
  {#if 'Administrator' === $session.role}
    <Actions>
      <ActionButtons>
        <Button
          color="primary"
          class="action-button"
          disabled={isEditMode && !canSave}
          on:click={() => (isEditMode = !isEditMode && edit()) || save()}>
          <Label>{leftButton.label}</Label>
          <Icon class="material-icons">{leftButton.icon}</Icon>
        </Button>
        <Button
          color="primary"
          class="action-button"
          on:click={() => (isEditMode = !isEditMode && setDeleteMenuOpen(true))}>
          <Label>{rightButton.label}</Label>
          <Icon class="material-icons">{rightButton.icon}</Icon>
        </Button>
      </ActionButtons>
      <ActionIcons style="position: relative;">
        <IconButton
          class="material-icons"
          on:click={() => cardMenu.setOpen(true)}
          toggle
          aria-label="Add to favorites"
          title="Add to favorites">
          more_vert
        </IconButton>
        <Menu bind:this={cardMenu}>
          <List>
            <Item on:click={() => createPoster('image')}>
              <Text>New Poster</Text>
            </Item>
            <Item
              disabled={!$images.length}
              on:click={() => imageList.setOpen(true)}>
              <Text>Select Poster</Text>
            </Item>
            <Separator />
            <Item
              disabled={!video.image_id}
              on:SMUI:action={() => removePoster()}>
              <Text>Remove Poster</Text>
            </Item>
            <Item class="text-red-700" on:SMUI:action={() => del()}>
              <Text>Delete Video</Text>
            </Item>
          </List>
        </Menu>
        <Menu bind:this={deleteMenu}>
          <List>
            <Item class="text-red-700" on:SMUI:action={() => del()}>
              <Text>Delete Video</Text>
            </Item>
          </List>
        </Menu>
      </ActionIcons>
      <div use:Anchor bind:this={imageListAnchor}>
        <MenuSurface
          anchor={false}
          bind:this={imageList}
          bind:anchorElement={imageListAnchor}
          on:MDCMenuSurface:opened={imageListOpenedHandler}
          on:MDCMenuSurface:closed={imageListClosedHandler}>
          <ImageList class="menu-surface-image-list">
            {#if isImageListOpen}
              {#each $images as image, i (image.id)}
                {#await getCachedImage(image.id)}
                  <div />
                {:then src}
                  <ImageListItem>
                    <ImageAspectContainer>
                      <Image
                        class="preview-image"
                        on:click={() => selectPoster(image.id)}
                        {src} />
                    </ImageAspectContainer>
                  </ImageListItem>
                {/await}
              {/each}
            {/if}
          </ImageList>
        </MenuSurface>
      </div>
    </Actions>
  {/if}
</Card>
