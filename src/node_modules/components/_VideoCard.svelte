<script>
  import * as api from "api.js";
  import { stores } from "@sapper/app";
  import { onDestroy, getContext, createEventDispatcher } from "svelte";
  import { fly } from "svelte/transition";
  import { videos } from "../../stores/videoStore";
  import { urls } from "../../stores/urlStore";
  import { crud } from "../../stores/crudStore";
  import { getMedia } from "utils";
  import MediaItem from "./_MediaItem.svelte";
  import VideoUploader from "./_ImageUploader.svelte";
  import Card, {
    Content,
    PrimaryAction,
    Actions,
    ActionButtons,
    ActionIcons,
  } from "@smui/card";
  import Button, { Label } from "@smui/button";
  import IconButton, { Icon } from "@smui/icon-button";
  import Menu from "@smui/menu";
  import MenuSurface, { Anchor } from "@smui/menu-surface";
  import ImageList, {
    Item as ImageListItem,
    ImageAspectContainer,
    Image,
  } from "@smui/image-list";
  import List, {
    Item,
    Separator,
    Text,
    PrimaryText,
    SecondaryText,
    Graphic,
  } from "@smui/list";
  import "./menu-surface.scss";

  export let video;
  export let images;
  export { className as class };

  const { open } = getContext("simple-modal");
  const { session } = stores();
  const EDIT = "edit";
  const SAVE = "save";
  const DELETE = "delete";
  const CANCEL = "cancel";

  let user = $session.user;
  let role = $session.role;
  let className = "";
  let cardMenu;
  let deleteMenu;
  let dispatch = createEventDispatcher();
  let imageList;
  let imageListAnchor;
  let activeEditor = false;
  let title;
  let description;
  let labelMode_1;
  let labelMode_2;
  let dateOptions = {
    weekday: "long",
    year: "numeric",
    month: "2-digit",
    day: "numeric",
    hour: "numeric",
    minute: "numeric",
  };
  let isImageListOpen = false;

  $: mode_1 = activeEditor ? "Save" : "Edit";
  $: mode_2 = activeEditor ? "Cancel" : "Delete";
  $: labelMode_1 = activeEditor ? SAVE : EDIT;
  $: labelMode_2 = activeEditor ? CANCEL : DELETE;
  $: matchingData =
    video["_matchingData"] && video["_matchingData"]["UsersVideos"];

  onDestroy(() => {
    dispatch("Video:current", null);
  });

  function save() {
    if (description !== video.description || title !== video.title) {
      video.title = title;
      video.description = description;
      crud.dispatch({
        method: "put",
        data: video,
      });
    }
  }
  function edit() {
    title = video.title || "";
    description = video.description || "";
    return true;
  }
  function setDeleteMenuOpen(b) {
    deleteMenu.setOpen(b);
    return false;
  }
  async function del() {
    let id = video.id;
    const res = await api.del(`videos/${id}`, user && user.token);

    if (res && res.success) {
      urls.del(id);
      videos.del(id);
    }
  }

  function selectPoster(id) {
    video.image_id = id;
    crud.dispatch({
      method: "put",
      data: video,
    });
  }

  function removePoster() {
    video.image_id = null;
    crud.dispatch({
      method: "put",
      data: video,
    });
  }

  function createPoster() {
    dispatch("Video:current", video);

    open(
      VideoUploader,
      {},
      {
        transitionWindow: fly,
        transitionWindowProps: {
          y: -200,
          duration: 500,
        },
      }
    );
  }

  function getCachedImage(id) {
    let res = getMedia("IMAGE", id, user, {
      width: 100,
      height: 100,
      square: 1,
    });
    return res;
  }

  function imageListOpenedHandler(e) {
    isImageListOpen = true;
  }
  function imageListClosedHandler(e) {
    isImageListOpen = false;
  }
</script>

<style>
  :global(.preview-image) {
    cursor: pointer;
  }
  .text-inherit > :global(*) {
    font-size: inherit;
  }
  :global(.activeEditor) {
    display: none;
  }
  .date {
    color: var(--text-light);
    padding: 3px 6px;
    line-height: 3em;
    font-size: 0.7rem;
    background: rgb(27, 85, 27);
  }
</style>

<Card
  class="flex content-between card {className}"
  style="width: var(--player-w);">
  <PrimaryAction>
    <MediaItem
      media={video}
      bind:title
      bind:description
      {activeEditor}
      {user} />
    <Content class="mdc-typography--body2">
      {#if role === 'Administrator'}
        <div class="text-xs text-inherit">
          <Icon class="material-icons">cloud_upload</Icon>
          <span>Created:</span>
          <span>{new Date(video.created).toLocaleDateString('de-DE', dateOptions)}</span>
        </div>
        <div
          class="opacity-25 text-xs text-inherit"
          class:opacity-25={!video.image_id}>
          <Icon class="material-icons">image</Icon>
          <span>Poster:</span>
          <span>{video.image_id || 'No Poster'}</span>
        </div>
      {:else}
        <div class="text-xs text-inherit">
          <Icon class="material-icons">lock_open</Icon>
          <span>End of Subscription:</span>
          <span
            class="date">{new Date(matchingData.end).toLocaleDateString('de-DE', dateOptions)}</span>
        </div>
      {/if}
    </Content>
  </PrimaryAction>
  {#if $session.role === 'Administrator'}
    <Actions>
      <ActionButtons>
        <Button
          color="primary"
          on:click={() => (activeEditor = !activeEditor && edit()) || save()}>
          <Label>{mode_1}</Label>
          <Icon class="material-icons">{labelMode_1}</Icon>
        </Button>
        <Button
          color="primary"
          on:click={() => (activeEditor = !activeEditor && setDeleteMenuOpen(true))}>
          <Label>{mode_2}</Label>
          <Icon class="material-icons">{labelMode_2}</Icon>
        </Button>
      </ActionButtons>
      <ActionIcons style="position: relative;">
        <IconButton
          class="material-icons"
          on:click={() => cardMenu.setOpen(true)}
          toggle
          aria-label="Add to favorites"
          title="Add to favorites">
          more_vert
        </IconButton>
        <Menu bind:this={cardMenu}>
          <List>
            <Item on:click={() => createPoster()}>
              <Text>New Poster</Text>
            </Item>
            <Item
              disabled={!$images.length}
              on:click={() => imageList.setOpen(true)}>
              <Text>Select Poster</Text>
            </Item>
            <Separator />
            <Item
              disabled={!video.image_id}
              on:SMUI:action={() => removePoster()}>
              <Text>Remove Poster</Text>
            </Item>
            <Item class="text-red-700" on:SMUI:action={() => del()}>
              <Text>Delete Video</Text>
            </Item>
          </List>
        </Menu>
        <Menu bind:this={deleteMenu}>
          <List>
            <Item class="text-red-700" on:SMUI:action={() => del()}>
              <Text>Delete Video</Text>
            </Item>
          </List>
        </Menu>
      </ActionIcons>
      <div use:Anchor bind:this={imageListAnchor}>
        <MenuSurface
          anchor={false}
          bind:this={imageList}
          bind:anchorElement={imageListAnchor}
          on:MDCMenuSurface:opened={imageListOpenedHandler}
          on:MDCMenuSurface:closed={imageListClosedHandler}>
          <ImageList class="menu-surface-image-list">
            {#if isImageListOpen}
              {#each $images as image, i (image.id)}
                {#await getCachedImage(image.id)}
                  <div />
                {:then src}
                  <ImageListItem>
                    <ImageAspectContainer>
                      <Image
                        class="preview-image"
                        on:click={() => selectPoster(image.id)}
                        {src} />
                    </ImageAspectContainer>
                  </ImageListItem>
                {/await}
              {/each}
            {/if}
          </ImageList>
        </MenuSurface>
      </div>
    </Actions>
  {/if}
</Card>
