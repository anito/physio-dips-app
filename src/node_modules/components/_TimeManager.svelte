<script>
	import * as api from 'api.js';
  	import { get } from "svelte/store";
	import { stores } from '@sapper/app';
	import List, { Item, Graphic, Meta, Separator, Subheader, Text, PrimaryText, SecondaryText } from '@smui/list';
	import Button, {Label, Icon} from '@smui/button';
	import Textfield, {Input, Textarea} from '@smui/textfield';
	import Snackbar, {Actions, Label as SnackbarLabel} from '@smui/snackbar';
	import SimpleVideoCard from 'components/SimpleVideoCard';
	import { videos } from '../../stores/videoStore';
	import { users } from '../../stores/userStore';
	import { toLocalDate } from 'utils';
	import { DateRangePicker } from '@sveltejs/site-kit/';
	import {
		addHours,
		endOfWeek,
		startOfWeek,
		startOfDay,
		startOfMonth,
		endOfDay,
		formatISO9075,
		parseISO
	} from 'date-fns';
	import * as locales from 'date-fns/locale';
	
	export let selectionUserId;
	
	const { session } = stores();
	const maxDate = undefined
	
	let locale = locales.de;
	let dateFormat = "dd. MMM yyyy";
	let firstDayOfWeek = "monday";
	let user = $session.user;
	let snackbar;
	let errors;
	let message;
	let filtered;
	let currentUser;
	let selectionVideoId;
	let joinData;
	let startDate;
	let endDate;
	let selectedVideo;
	let userVideos = [];
	let _userVideos;
	let ids = [];

	$: user = $session.user;
	$: currentUserIndex = (typeof selectionUserId === 'number') && (id => $users.findIndex(usr => usr.id === id))(selectionUserId);
	$: userVideos = $videos && getUserVideos(currentUserIndex); // make reactive in case video store has changed
	$: (() => (selectionVideoId = null) )(selectionUserId);
	$: currentUser = ( filtered = ( id => $users.filter( usr => usr.id === id ) )(selectionUserId)) && filtered.length && filtered[0];
	$: joinData = (selectedVideo = currentUser.videos.find(v => v.id === selectionVideoId)) && selectedVideo._joinData;
	$: startDate = joinData && joinData.start && parseISO(joinData.start) || startOfDay(new Date());
	$: endDate = joinData && joinData.end && parseISO(joinData.end) || startDate;
	$: noneUserVideos = $videos.filter( vid => !userVideos.find( uv => vid.id === uv.id ));

	async function videoSelectedHandler(e) {
		let video = e.detail;
		if(video.id == selectionVideoId) {
			selectionVideoId = null
		} else {
			selectionVideoId = video.id;
		}
	}
	
	function handleClosed() {
		//
	}

	function getUserVideos(idx) {
		let _videos = get(videos);
		let _users = get(users);
		let _userVideos;
		
		if (_users[idx] && (_userVideos = _users[idx].videos)) {
			return _videos.filter((v) => _userVideos.find( uv => uv.id === v.id));
		}
		return [];
	}

	function setUserVideos_(idx, videos) {
		userVideos = videos.slice();
		$users[idx] && ($users[idx].videos = videos);
	}

	function getUserVideoIds(video) {
		let idx;
		if(-1 !== (idx = userVideos.findIndex(itm=>itm.id === video.id))) {
			// remove
			_userVideos = [...userVideos.slice(0, idx), ...userVideos.slice(idx + 1)]
		} else {
			// add
			_userVideos = [...userVideos, video];
		}
		ids = _userVideos.map(v=>v.id);
		
		return ids;
	}

	function onApplyHandler({ detail }) {
		let startDate = detail.startDate;
		let endDate = detail.endDate;

		let startYear = startDate.getFullYear();
		let startMonth = startDate.getMonth();
		let startDay = startDate.getDate();
		let startHours = startDate.getHours();
		let startMinutes = startDate.getMinutes();
		let startSeconds = startDate.getSeconds();

		let endYear = endDate.getFullYear();
		let endMonth = endDate.getMonth();
		let endDay = endDate.getDate();
		let endHours = endDate.getHours();
		let endMinutes = endDate.getMinutes();
		let endSeconds = endDate.getSeconds();

		let isoStart = formatISO9075(new Date(startYear, startMonth, startDay, startHours, startMinutes, startSeconds));
		let isoEnd = formatISO9075(new Date(endYear, endMonth, endDay, endHours, endMinutes, endSeconds));
		
		saveTime(isoStart, isoEnd)
	}

	async function saveTime(start, end, id=selectionVideoId) {
		let associated = userVideos.filter(v => v.id != id).map(v => ({id: v.id}));
		let data = { 'videos': 
		[
				{
					'id': id,
					'_joinData': { start, end }
				}, 
				...associated
		]};
		
		const res = await api.put(`users/${selectionUserId}`, data, user && user.token);
		if(res && res.success) {
			let video, videos, idx;

			video = currentUser.videos.find(v => v.id === id);

			if(video) {
				video._joinData = {...video._joinData, start, end};
				idx = currentUser.videos.findIndex(v => v.id == video.id);
				
				videos = currentUser.videos.slice();
				videos = [...videos.slice(0, idx), { ...videos[idx], ...video }, ...videos.slice(idx + 1)];
				currentUser.videos = videos;

			}
			users.put(currentUser);

		} else {
			this.error(res.status, res.data.message);
		}
	}

	async function toggle(video) {

		let ids = getUserVideoIds(video);

		// confirm remove dialoge
		if(ids.length < userVideos.length && !confirm(`Remove Video "${video.title}" from Subscription?`)) return;

		let data = { 'videos': {'_ids': [...ids]} };
		
		const res = await api.put(`users/${selectionUserId}`, data, user && user.token);

		if(res && res.success) {
			userVideos = _userVideos;
			$users[currentUserIndex] && ($users[currentUserIndex].videos = _userVideos);
		} else {
			this.error(res.status, res.data.message);
		}
		return false;
	}
	
</script>

<style>
    .grid-item {
        background: var(--back-grid-item);
	}
    .user-videos {
		grid-area: one;
		overflow: auto;
	}
    .time, .videos {
		grid-area: two;
		overflow: auto;
	}
	.time {
		background: #fff;
	}
	.no-user-selected, .no-videos {
		display: flex;
		justify-content: center;
		align-items: center;
	}
	:global(.item > label) {
		width: 100%;
	}
</style>
<div class="grid-item user-videos" class:no-user-selected={!currentUser} class:no-videos={!userVideos.length}>
	{#if currentUser}
		{#if userVideos.length}
			<List class="video-list" twoLine avatarList singleSelection>
				{#each userVideos as video (video.id)}
					<SimpleVideoCard let:published
						class="user-video"
						on:videoSelected={videoSelectedHandler}
						on:videoSelected
						{video}
						{selectionUserId}
						bind:selectionVideoId
						emptyDateText="Not published"
						emphasizeEmptyDate
					>
						<Button class="delete-action-button delete" on:click={(e) => toggle(video)}><Icon class="material-icons">remove_circle_outline</Icon><Label></Label></Button>
						<Button disabled={!published} class="unpublish-action-button" on:click={(e) => saveTime(null, null, video.id)}><Icon class="material-icons">auto_delete</Icon><Label></Label></Button>
					</SimpleVideoCard>
				{/each}
			</List>
		{:else}
			<div class="user-video">User has no Videos</div>
		{/if}
	{:else}
	No User Selected
	{/if}
</div>
{#if selectionVideoId}
	<div class="grid-item time">
		<DateRangePicker
			{locale}
			{firstDayOfWeek}
			{startDate}
			{endDate}
			{maxDate}
			{dateFormat}
			on:apply={onApplyHandler}
			disabled={!selectionVideoId}
			resetTrigger={selectionVideoId}
			weekGuides
			weekNumbers
			todayBtn
			twoPages
			resetViewBtn
			timePicker
			timePickerSeconds
			timePickerControls
			todayBtnText = "Heute"
			cancelBtnText = "Reset"
			applyBtnText = "Anwenden"
			actionBtnClass = "picker-btn mdc-button mdc-ripple-upgraded mdc-button--unelevated"
		/>
	</div>
{:else}
	<div class="grid-item videos" class:no-videos={!noneUserVideos.length}>
		<List class="video-list" twoLine avatarList singleSelection>
			{#if noneUserVideos.length}
				{#each noneUserVideos as video (video.id)}
					<SimpleVideoCard
						class="video"
						emptyDateText={video.description}
						{video}
						{selectionUserId}
					>
						<Button class="add-action-button add" color="primary" on:click={(e) => toggle(video)}><Icon class="material-icons">add_circle_outline</Icon><Label></Label></Button>
					</SimpleVideoCard>
				{/each}
			{:else}
				<div class="user-video">No more videos available</div>
			{/if}
		</List>
	</div>
{/if}

<Snackbar timeoutMs=4000 variant="stacked" bind:this={snackbar} labelText={message} on:MDCSnackbar:closed={handleClosed}>
	<SnackbarLabel></SnackbarLabel>
</Snackbar>