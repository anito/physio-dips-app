<script>
  import * as api from "api.js";
  import "./icon-button.scss";
  import { stores } from "@sapper/app";
  import List from "@smui/list";
  import IconButton, { Icon } from "@smui/icon-button";
  import Snackbar, { Actions, Label as SnackbarLabel } from "@smui/snackbar";
  import Fab, { Label as FabLabel, Icon as FabIcon } from "@smui/fab";
  import SimpleVideoCard from "components/SimpleVideoCard";
  import { videos } from "../../stores/videoStore";
  import { users } from "../../stores/userStore";
  import { DateRangePicker } from "@sveltejs/site-kit/";
  import {
    addHours,
    endOfWeek,
    startOfWeek,
    startOfDay,
    startOfMonth,
    endOfDay,
    formatISO9075,
    parseISO,
  } from "date-fns";
  import * as locales from "date-fns/locale";

  export let selectionUserId;

  const { session } = stores();
  const maxDate = undefined;

  let userRole;
  let locale = locales.de;
  let dateFormat = "dd. MMM yyyy";
  let firstDayOfWeek = "monday";
  let snackbar;
  let errors;
  let message;
  let filtered;
  let currentUser;
  let selectionVideoId;
  let selectedVideo;
  let userVideos = [];
  let _userVideos;
  let ids = [];

  $: user = $session.user;
  $: currentUserIndex =
    typeof selectionUserId === "number" &&
    ((id) => $users.findIndex((usr) => usr.id === id))(selectionUserId);
  $: userVideos = $users[currentUserIndex].videos;
  $: (() => (selectionVideoId = null))(selectionUserId);
  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(
      selectionUserId
    )) &&
    filtered.length &&
    filtered[0];
  $: userRole = currentUser["group"]["name"];
  $: joinData =
    (selectedVideo = currentUser.videos.find(
      (v) => v.id === selectionVideoId
    )) && selectedVideo._joinData;
  $: startDate =
    (joinData && joinData.start && parseISO(joinData.start)) ||
    startOfDay(new Date(0));
  $: endDate =
    (joinData && joinData.end && parseISO(joinData.end)) ||
    endOfDay(new Date(0));
  $: noneUserVideos = $videos.filter(
    (v) => !userVideos.find((uv) => v.id === uv.id)
  );

  async function videoSelectedHandler(e) {
    let video = e.detail;
    if (video.id == selectionVideoId) {
      selectionVideoId = null;
    } else {
      selectionVideoId = video.id;
    }
  }

  function handleClosed() {
    //
  }

  function getUserVideoIds(video) {
    let idx;
    if (-1 !== (idx = userVideos.findIndex((itm) => itm.id === video.id))) {
      // remove video from user videos
      _userVideos = [...userVideos.slice(0, idx), ...userVideos.slice(idx + 1)];
    } else {
      // add video to user videos
      _userVideos = [...userVideos, video];
    }
    ids = _userVideos.map((v) => v.id);

    return ids;
  }

  function onApplyHandler({ detail }) {
    let startDate = detail.startDate;
    let endDate = detail.endDate;

    let startYear = startDate.getFullYear();
    let startMonth = startDate.getMonth();
    let startDay = startDate.getDate();
    let startHours = startDate.getHours();
    let startMinutes = startDate.getMinutes();
    let startSeconds = startDate.getSeconds();

    let endYear = endDate.getFullYear();
    let endMonth = endDate.getMonth();
    let endDay = endDate.getDate();
    let endHours = endDate.getHours();
    let endMinutes = endDate.getMinutes();
    let endSeconds = endDate.getSeconds();

    let isoStart = formatISO9075(
      new Date(
        startYear,
        startMonth,
        startDay,
        startHours,
        startMinutes,
        startSeconds
      )
    );
    let isoEnd = formatISO9075(
      new Date(endYear, endMonth, endDay, endHours, endMinutes, endSeconds)
    );

    saveTime(isoStart, isoEnd);
  }

  async function saveTime(start, end, id = selectionVideoId, e) {
    e && e.stopPropagation();

    let associated = userVideos
      .filter((v) => v.id != id)
      .map((v) => ({ id: v.id }));
    let data = {
      videos: [
        {
          id: id,
          _joinData: { start, end },
        },
        ...associated,
      ],
    };

    const res = await api.put(
      `users/${selectionUserId}`,
      data,
      user && user.token
    );
    if (res && res.success) {
      let video, videos, idx;

      video = currentUser.videos.find((v) => v.id === id);

      if (video) {
        video._joinData = { ...video._joinData, id, start, end };
        idx = currentUser.videos.findIndex((v) => v.id == video.id);

        videos = currentUser.videos.slice();
        videos = [
          ...videos.slice(0, idx),
          { ...videos[idx], ...video },
          ...videos.slice(idx + 1),
        ];
        currentUser.videos = videos;
      }
      users.put(currentUser);
    } else {
      this.error(res.status, res.data.message);
    }
  }

  async function toggle(video, e) {
    e && e.stopPropagation();

    let ids = getUserVideoIds(video);
    let isRemove = ids.length < userVideos.length;

    // confirm remove dialoge
    if (isRemove) {
      if (!confirm(`Remove Video "${video.title}" from Subscription?`)) return;
    }

    let data = { videos: { _ids: [...ids] } };

    const res = await api.put(
      `users/${selectionUserId}`,
      data,
      user && user.token
    );

    if (res.success) {
      currentUser.videos = _userVideos.slice();
      users.put(currentUser);
      if (isRemove && selectionVideoId === video.id) selectionVideoId = null;
    } else {
      this.error(res.status, res.data.message);
    }
  }
</script>

<style>
  .grid-item {
    background: var(--back-grid-item);
  }
  .user-videos {
    grid-area: one;
    overflow: auto;
  }
  .time,
  .videos {
    grid-area: two;
    overflow: auto;
  }
  .time {
    background: #fff;
  }
  .no-user-selected,
  .no-videos {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  :global(.item > label) {
    width: 100%;
  }
</style>

<div
  class="grid-item user-videos"
  class:no-user-selected={!currentUser}
  class:no-videos={!userVideos.length || userRole === 'Administrator'}>
  {#if currentUser}
    {#if userRole !== 'Administrator' && userVideos.length}
      <List class="video-list" threeLine avatarList singleSelection>
        {#each userVideos as video (video.id)}
          <SimpleVideoCard
            let:published
            threeLine
            class="user-video"
            on:videoSelected={videoSelectedHandler}
            on:videoSelected
            {video}
            {selectionUserId}
            bind:selectionVideoId
            emptyDateText="Not published"
            emphasizeEmptyDate>
            <IconButton
              class="delete-action-button delete"
              on:click={(e) => toggle(video, e)}>
              <Icon class="material-icons">remove_circle_outline</Icon>
            </IconButton>
            <IconButton
              disabled={!published}
              class="unpublish-action-button"
              on:click={(e) => saveTime(null, null, video.id, e)}>
              <Icon class="material-icons">auto_delete</Icon>
            </IconButton>
          </SimpleVideoCard>
        {/each}
      </List>
    {:else if userRole === 'Administrator'}
      <div class="user-video">Admins have access to all Videos</div>
    {:else}
      <div class="user-video">User has no Videos</div>
    {/if}
  {:else}No User Selected{/if}
</div>
{#if selectionVideoId}
  <div class="grid-item time">
    <DateRangePicker
      {locale}
      {firstDayOfWeek}
      {startDate}
      {endDate}
      {maxDate}
      {dateFormat}
      on:apply={onApplyHandler}
      disabled={!selectionVideoId}
      resetTrigger={selectionVideoId}
      weekGuides
      weekNumbers
      todayBtn
      twoPages
      resetViewBtn
      timePicker
      timePickerSeconds
      timePickerControls
      todayBtnText="Heute"
      cancelBtnText="Reset"
      applyBtnText="Anwenden"
      actionBtnClass="picker-btn mdc-button mdc-ripple-upgraded mdc-button--unelevated" />
  </div>
  <Fab
    disabled={!noneUserVideos.length}
    class="floating-fab"
    color="primary"
    on:click={() => (selectionVideoId = null)}
    extended>
    <FabLabel>Add Video</FabLabel>
    <FabIcon class="material-icons">add</FabIcon>
  </Fab>
{:else}
  <div class="grid-item videos" class:no-videos={!noneUserVideos.length}>
    {#if noneUserVideos.length}
      <List class="video-list" twoLine avatarList singleSelection>
        {#each noneUserVideos as video (video.id)}
          <SimpleVideoCard
            let:unmanagable
            class="video"
            emptyDateText={video.description}
            disabled={userRole === 'Administrator'}
            {video}
            {selectionUserId}>
            <IconButton
              disabled={unmanagable}
              class="add-action-button add"
              color="primary"
              on:click={(e) => toggle(video, e)}>
              <Icon class="material-icons">add_circle_outline</Icon>
            </IconButton>
          </SimpleVideoCard>
        {/each}
      </List>
    {:else}
      <div class="user-video">No more videos available</div>
    {/if}
  </div>
{/if}

<Snackbar
  timeoutMs="4000"
  variant="stacked"
  bind:this={snackbar}
  labelText={message}
  on:MDCSnackbar:closed={handleClosed}>
  <SnackbarLabel />
</Snackbar>
