<script>
  import * as api from "api.js";
  import "./icon-button.scss";
  import "./date-range-picker.scss";
  import { goto, stores } from "@sapper/app";
  import { onMount, getContext } from "svelte";
  import { createRedirectSlug } from "utils";
  import List from "@smui/list";
  import Button, { Label, Icon as ButtonIcon } from "@smui/button";
  import IconButton, { Icon } from "@smui/icon-button";
  import SimpleVideoCard from "components/SimpleVideoCard";
  import { videos } from "../../stores/videoStore";
  import { users } from "../../stores/userStore";
  import { flash } from "../../stores/flashStore";
  import { DateRangePicker } from "@sveltejs/site-kit/";
  import Component from "./_Component.svelte";
  import {
    addHours,
    endOfWeek,
    startOfWeek,
    startOfDay,
    startOfMonth,
    endOfDay,
    formatISO9075,
    parseISO,
  } from "date-fns";
  import * as locales from "date-fns/locale";

  export let selectionUserId;

  const { page, session } = stores();
  const maxDate = undefined;
  const user = $session.user;
  const { getSnackbar, configSnackbar } = getContext("snackbar");

  let root;
  let currentRole;
  let locale = locales.de;
  let dateFormat = "dd. MMM yyyy";
  let firstDayOfWeek = "monday";
  let snackbar;
  let code;
  let message;
  let filtered;
  let group;
  let currentUser;
  let selectedIndex;
  let selectionVideoId;
  let selectedVideo;
  let userVideos = [];
  let _userVideos;

  $: currentUserIndex =
    typeof selectionUserId === "number" &&
    ((id) => $users.findIndex((usr) => usr.id === id))(selectionUserId);
  $: userVideos = $users[currentUserIndex] && $users[currentUserIndex].videos;
  $: (() => (selectionVideoId = null))(selectionUserId);
  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(
      selectionUserId
    )) &&
    filtered.length &&
    filtered[0];
  $: currentRole =
    (group = ((usr) =>
      $session.groups &&
      $session.groups.find((group) => group.id == usr.group_id))(
      currentUser
    )) && group.name;
  $: joinData =
    (selectedVideo =
      currentUser &&
      currentUser.videos.find((v) => v.id === selectionVideoId)) &&
    selectedVideo._joinData;
  $: startDate =
    (joinData && joinData.start && parseISO(joinData.start)) ||
    startOfDay(new Date(0));
  $: endDate =
    (joinData && joinData.end && parseISO(joinData.end)) ||
    endOfDay(new Date(0));
  $: noneUserVideos = $videos.filter(
    (v) => !userVideos.find((uv) => v.id === uv.id)
  );
  $: root && root.classList.toggle("datapicker--open", selectionVideoId);

  onMount(() => {
    root = document.documentElement;
    root.classList.add("timemanager--open");

    snackbar = getSnackbar();
    return () => root.classList.remove("timemanager--open", "datapicker--open");
  });

  async function itemSelectedHandler(e) {
    let { video } = e.detail;
    selectionVideoId = video.id == selectionVideoId ? null : video.id;
  }

  function onApplyHandler({ detail }) {
    let startDate = detail.startDate;
    let endDate = detail.endDate;

    let startYear = startDate.getFullYear();
    let startMonth = startDate.getMonth();
    let startDay = startDate.getDate();
    let startHours = startDate.getHours();
    let startMinutes = startDate.getMinutes();
    let startSeconds = startDate.getSeconds();

    let endYear = endDate.getFullYear();
    let endMonth = endDate.getMonth();
    let endDay = endDate.getDate();
    let endHours = endDate.getHours();
    let endMinutes = endDate.getMinutes();
    let endSeconds = endDate.getSeconds();

    let isoStart = formatISO9075(
      new Date(
        startYear,
        startMonth,
        startDay,
        startHours,
        startMinutes,
        startSeconds
      )
    );
    let isoEnd = formatISO9075(
      new Date(endYear, endMonth, endDay, endHours, endMinutes, endSeconds)
    );

    saveTime(selectionVideoId, isoStart, isoEnd);
  }

  async function saveTime(id, start, end) {
    let associated = userVideos
      .filter((v) => v.id != id)
      .map((v) => ({ id: v.id }));
    let data = {
      videos: [
        {
          id: id,
          _joinData: { start, end },
        },
        ...associated,
      ],
    };

    const res = await saveUser(data);

    if (res.success) {
      let video, videos, idx;

      video = currentUser.videos.find((v) => v.id === id);

      if (video) {
        video = Object.create(video);
        video._joinData = { ...video._joinData, start, end };

        idx = currentUser.videos.findIndex((v) => v.id == video.id);
        videos = currentUser.videos.slice();
        videos = [
          ...videos.slice(0, idx),
          { ...videos[idx], ...video },
          ...videos.slice(idx + 1),
        ];
        currentUser.videos = videos;
      }
      handleSuccess(res, currentUser, "Zeitfenster aktualisiert");
    } else {
      handleError(res);
    }
  }

  function timeRemaining(video) {
    let end;
    return (
      video._joinData &&
      (end = video._joinData.end) &&
      Math.max(0, new Date(end) - new Date())
    );
  }

  async function toggle(video, e) {
    e && e.stopPropagation();

    let ids = setUserVideos(video);
    let isAdded = (ids.length > userVideos.length && video) || false;

    // confirm remove dialoge only if start date exists

    if (!isAdded && timeRemaining(video)) {
      !confirm(
        `Dieser Kurs verfügt über ein aktives Zeitfenster. Den gebuchten Kurs "${video.title}" trotzdem entfernen?`
      );
      return;
    }

    let data = { videos: { _ids: [...ids] } };

    const res = await saveUser(data);

    if (res.success) {
      if (!isAdded) {
        selectionVideoId === video.id && (selectionVideoId = null);
      }

      currentUser.videos = _userVideos.slice();
      handleSuccess(
        res,
        currentUser,
        isAdded ? "Video hinzugefügt" : "Video entfernt"
      );
    } else {
      handleError(res);
    }
  }

  function setUserVideos(video) {
    let ids, idx;
    if (-1 !== (idx = userVideos.findIndex((itm) => itm.id === video.id))) {
      // remove video from user videos
      _userVideos = [...userVideos.slice(0, idx), ...userVideos.slice(idx + 1)];
    } else {
      // add video to user videos
      _userVideos = [...userVideos, video];
    }
    ids = _userVideos.map((v) => v.id);

    return ids;
  }

  function saveUser(data) {
    return api.put(`users/${selectionUserId}`, data, user && user.token);
  }

  function handleSuccess(res, user, msg) {
    snackbar.isOpen && snackbar.close();
    users.put(user);

    message = msg || res.message || res.data.message;
    configSnackbar(message);
    snackbar.open();
  }

  function handleError(res) {
    let path;
    snackbar.isOpen && snackbar.close();

    message = res.message || res.data.message || res.statusText;
    code = (res.data && res.data.code) || res.status;

    if (400 <= code && code < 500) {
      configSnackbar(message);
      snackbar.open();
    } else {
      flash.update({ type: "error", message });
      path = `login${createRedirectSlug($page)}`;
      configSnackbar(message, path);
      snackbar.open();
    }
  }
</script>

<style>
  .grid-item {
    background: var(--back-grid-item);
  }
  .user-videos {
    grid-area: one;
    overflow: auto;
  }
  .time,
  .videos {
    grid-area: two;
    overflow: auto;
  }
  .time {
    background: #fff;
  }
  .no-user-selected {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  :global(.item > label) {
    width: 100%;
  }
</style>

<div
  class="grid-item user-videos"
  class:no-user-selected={!currentUser}
  class:no-videos={!userVideos.length || currentRole === 'Administrator'}>
  <Component>
    <div slot="header">
      <h2>Gebuchte Kurse</h2>
    </div>
    <List
      class="video-list"
      threeLine
      avatarList
      singleSelection
      bind:selectedIndex>
      {#if 'Administrator' !== currentRole}
        {#if userVideos.length}
          {#each userVideos as video (video.id)}
            <SimpleVideoCard
              disabled={'Administrator' !== $session.role}
              threeLine
              class="user-video video-list-item"
              on:itemSelected={itemSelectedHandler}
              on:itemSelected
              selected={selectionVideoId === video.id}
              {video}
              {selectionUserId}
              emptyDateText="Zeitfenster nicht definiert"
              emphasizeEmptyDate>
              {#if 'Administrator' === $session.role}
                <IconButton
                  class="delete-action-button delete"
                  on:click={(e) => toggle(video, e)}>
                  <Icon class="material-icons">remove_circle_outline</Icon>
                </IconButton>
                <Button
                  class="close-action-button button-shaped-round flex self-center"
                  variant="outlined">
                  <Label>Zeitraum</Label>
                  <ButtonIcon class="material-icons">
                    {selectionVideoId === video.id ? 'close' : 'schedule'}
                  </ButtonIcon>
                </Button>
              {/if}
            </SimpleVideoCard>
          {/each}
        {:else}
          <div class="flex flex-1 flex-col self-center text-center">
            <div class="my-10">
              {@html `User <strong>${currentUser.name}</strong> has no subscriptions`}
            </div>
          </div>
        {/if}
      {:else if currentRole === 'Administrator'}
        <div class="flex flex-1 flex-col self-center text-center">
          <div class="my-10">Admins have full access to videos</div>
        </div>
      {/if}
    </List>
  </Component>
</div>
{#if selectionVideoId}
  <div class="grid-item time">
    <DateRangePicker
      customHeaderHeight
      class="sm-header"
      {locale}
      {firstDayOfWeek}
      {startDate}
      {endDate}
      {maxDate}
      {dateFormat}
      on:apply={onApplyHandler}
      disabled={!selectionVideoId}
      resetTrigger={selectionVideoId}
      weekGuides
      weekNumbers
      todayBtn
      twoPages
      resetViewBtn
      timePicker
      timePickerSeconds
      timePickerControls
      todayBtnText="Heute"
      cancelBtnText="Reset"
      applyBtnText="Anwenden"
      actionBtnClass="picker-btn mdc-button mdc-ripple-upgraded mdc-button--unelevated" />
  </div>
{:else}
  <div class="grid-item videos" class:no-videos={!noneUserVideos.length}>
    <Component>
      <div slot="header">
        <h2>Weitere Kurse</h2>
      </div>
      {#if noneUserVideos.length}
        <List class="video-list" twoLine avatarList singleSelection>
          {#each noneUserVideos as video (video.id)}
            <SimpleVideoCard
              let:unmanagable
              class="video"
              emptyDateText={video.description}
              disabled={currentRole === 'Administrator'}
              {video}
              {selectionUserId}>
              <IconButton
                disabled={unmanagable}
                class="add-action-button add"
                color="primary"
                on:click={(e) => toggle(video, e)}>
                <Icon class="material-icons">add_circle_outline</Icon>
              </IconButton>
              <IconButton
                disabled
                class="self-center"
                color="primary"
                on:click={async () => await goto(`videos/${video.id}`)}>
                <Icon class="material-icons">edit</Icon>
              </IconButton>
            </SimpleVideoCard>
          {/each}
        </List>
      {:else}
        <div class="flex flex-1 flex-col self-center text-center">
          <div class="my-10">No more videos available</div>
        </div>
      {/if}
    </Component>
  </div>
{/if}
