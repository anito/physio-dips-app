<script>
	import * as api from 'api.js';
	import { stores } from '@sapper/app';
	import List, { Item, Graphic, Meta, Separator, Subheader, Text, PrimaryText, SecondaryText } from '@smui/list';
	import Textfield, {Input, Textarea} from '@smui/textfield';
	import Snackbar, {Actions, Label as SnackbarLabel} from '@smui/snackbar';
	import SimpleVideoCard from 'components/SimpleVideoCard';
	import { videos } from '../../stores/videoStore';
	import { users } from '../../stores/userStore';
	import { DateRangePicker } from '@sveltejs/site-kit/';
	import {
		addHours,
		endOfWeek,
		startOfWeek,
		startOfDay,
		endOfDay
	} from 'date-fns';
	import * as locales from 'date-fns/locale';
	
	export let selectionUserId;
	export let getUserVideos;;
	
	const { session } = stores();
	const singlePicker = false;
	const maxDate = undefined
	
	let locale = locales.de;
	let dateFormat = "dd. MMM yyyy";
	let firstDayOfWeek = "monday";
	let user = $session.user;
	let snackbar;
	let errors;
	let message;
	let filtered;
	let currentUser;
	let selectionVideoId;
	let startDate = singlePicker
		? startOfDay(new Date())
		: startOfWeek(new Date());
	let endDate = singlePicker
		? startDate
		: endOfWeek(new Date())
		


	$: user = $session.user;
	$: currentUserIndex = (typeof selectionUserId === 'number') && (id => $users.findIndex(usr => usr.id === id))(selectionUserId);
	$: userVideos = $videos && getUserVideos(currentUserIndex); // make reactive in case video store has changed
	$: (() => (selectionVideoId = null) )(selectionUserId);
	$: currentUser = ( filtered = ( id => $users.filter( usr => usr.id === id ) )(selectionUserId)) && filtered.length && filtered[0];
	$: noUser = !currentUser;

	async function videoSelectedHandler(e) {

		let video = e.detail;
		if(video.id == selectionVideoId) {
			selectionVideoId = null
		} else {
			selectionVideoId = video.id;
		}
		
	}
	
	function handleClosed() {
		//
	}

	function onApply({ detail }) {
		startDate = detail.startDate
		endDate = detail.endDate
		console.log('onApply: ', detail)
	}
	
</script>

<style>
    .grid-item {
        background: var(--back-grid-item);
	}
    .user-videos {
		grid-area: one;
		overflow: auto;
	}
    .time {
		grid-area: two;
		overflow: auto;
	}
	.no-user-selected, .no-videos {
		display: flex;
		justify-content: center;
		align-items: center;
	}
	:global(.item > label) {
		width: 100%;
	}
</style>
<div class="grid-item user-videos" class:no-user-selected={noUser} class:no-videos={!userVideos.length}>
	{#if currentUser}
		{#if userVideos.length}
			<List class="video-list" twoLine avatarList singleSelection>
				{#each userVideos as video (video.id)}
					<SimpleVideoCard
						class="user-video"
						on:videoSelected={videoSelectedHandler}
						on:videoSelected
						{video}
						{selectionUserId}
						bind:selectionVideoId
						singleSelection
					/>
				{/each}
			</List>
		{:else}
			<div class="user-video">User has no Videos</div>
		{/if}
	{:else}
	No User Selected
	{/if}
</div>
<div class="grid-item time">
		<DateRangePicker
			{locale}
			{firstDayOfWeek}
			{addHours}
			weekGuides
			weekNumbers
			{maxDate}
			todayBtn
			twoPages
			resetViewBtn
			timePicker
			timePickerSeconds
			timePickerControls
			{startDate}
			{endDate}
			on:apply={onApply}
			{dateFormat}
			todayBtnText = "Heute"
			cancelBtnText = "Abbrechen"
			applyBtnText = "Anwenden"
		/>
</div>

<Snackbar timeoutMs=4000 variant="stacked" bind:this={snackbar} labelText={message} on:MDCSnackbar:closed={handleClosed}>
	<SnackbarLabel></SnackbarLabel>
</Snackbar>