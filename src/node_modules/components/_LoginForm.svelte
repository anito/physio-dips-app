<script>
    import { goto, stores } from '@sapper/app';
    import { post } from 'utils.js';
    import Button from '@smui/button';
    import Textfield, {Input, Textarea} from '@smui/textfield';
    import Icon from '@smui/textfield/icon/index';
    import HelperText from '@smui/textfield/helper-text';
    import { Label } from '@smui/common';
    import Snackbar, {Actions, Label as SnackbarLabel} from '@smui/snackbar';

    const { page, session } = stores();
    const adminPassword = "Test@005";
    const adminEmail = "test@webpremiere.de";
    const userPassword = "Angela@005";
    const userEmail = "angela@webpremiere.dev";

    let snackbar;
    let errors;
    let message;
    let redirectPath = $page.query.redirect || 'videos';
    let password = '';
    let email = '';

    $session.user = null;
    $session.role = null;
    
    async function submit( event ) {
        const res = await post("auth/login", {
            email,
            password
        })

        // TODO handle network errors
		errors = res.errors;
        message = res.message ||Â res.data.message;

		if (res.success) {
            res.data.user && ($session.user = res.data.user);
            res.data.role && ($session.role = res.data.role);
            
            // override redirectPath on non-administrators
            $session.role !== 'Administrator' && (redirectPath = 'videos');

            message += '. Redirecting...';
            snackbar.open();
		} else {
            redirectPath = null;
            snackbar.open();
        }
    };

    function handleClosed() {
        goto(redirectPath);
    }
    
    function setFields(type) {
        switch (type) {
            case 'admin':
                email = adminEmail;
                password =  adminPassword;
                break;
            case 'user':
                email = userEmail;
                password =  userPassword;
        }
    }
</script>

<style>

    .login-grid {
        display: grid;
        grid-gap: 5px;
        grid-row-gap: .5rem;
        grid-template-columns: 1fr;
        grid-template-rows: repeat(4, 1fr);
        grid-template-areas:
            "email"
            "pass"
            "button"
            "button";
    }

    .email-area {
        grid-area: email;
    }

    .pass-area {
        grid-area: pass;
    }

    .button-area-one {
        grid-area: button1;
    }

    .button-area-two {
        grid-area: button2;
    }

    .button-area-two :global(.login-button:only-child) {
        margin: 0;
    }
    .button-area-two :global(.login-button:nth-child(even)) {
        margin-left: 10px;
    }
    .button-area-two :global(.login-button:nth-child(odd)) {
        margin-right: 10px;
    }

    @media screen and (min-width: 840px) {

        .login-grid {
            grid-template-areas:
                "email pass"
                "button1 button1"
                "button2 button2";
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 2fr 1fr 1fr;
            grid-row-gap: 1rem;
        }
        
    }

</style>

<form on:submit|preventDefault={submit} method="post">
    <div class="login-grid">
        <span class="email-area lg:mr-2">
            <Textfield variant="outlined" withLeadingIcon bind:value={email} label="Email" autocomplete="user-email" input$aria-controls="helper-text-outlined-email" input$aria-describedby="helper-text-outlined-email" >
                <Icon class="material-icons">mail</Icon>
            </Textfield>
            <HelperText id="helper-text-outlined-email">Helper Text</HelperText>
        </span>
        <span class="pass-area lg:ml-2">
            <Textfield variant="outlined" type="password" withTrailingIcon bind:value={password} label="Password" autocomplete="user-password" input$aria-controls="helper-text-outlined-password" input$aria-describedby="helper-text-outlined-password" >
                <Icon class="material-icons">login</Icon>
            </Textfield>
            <HelperText id="helper-text-outlined-password">Helper Text</HelperText>
        </span>
        <div class="button-area-one flex">
            <Button class="login-button flex-1" type="submit" variant="raised"><Label>Login</Label></Button>
        </div>
        <div class="button-area-two flex">
            <Button on:click={()=>setFields('admin')} class="login-button flex-1" type="submit" variant="raised"><Label>Login as Admin</Label></Button>
            <Button on:click={()=>setFields('user')} class="login-button flex-1" type="submit" variant="raised"><Label>Login as User</Label></Button>
        </div>
    </div>
</form>

<Snackbar timeoutMs=4000 variant="stacked" bind:this={snackbar} labelText={message} on:MDCSnackbar:closed={handleClosed}>
	<SnackbarLabel></SnackbarLabel>
</Snackbar>