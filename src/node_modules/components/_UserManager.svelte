<script>
  import * as api from "api";
  import { getContext, onMount } from "svelte";
  import { fly } from "svelte/transition";
  import { stores } from "@sapper/app";
  import { getMedia, createRedirectSlug } from "utils";
  import { users } from "../../stores/userStore";
  import { flash } from "../../stores/flashStore";
  import Textfield from "@smui/textfield";
  import HelperText from "@smui/textfield/helper-text";
  import Button, { Label } from "@smui/button";
  import { Icon as CommonIcon } from "@smui/common";
  import Select, { Option } from "@smui/select";
  import { Icon as SelectIcon } from "@smui/select/icon";
  import { Icon as TextfieldIcon } from "@smui/textfield/icon";
  import Paper, { Title } from "@smui/paper";
  import Component from "./_Component.svelte";
  import MediaUploader from "./_MediaUploader.svelte";
  import Avatar from "./_Avatar.svelte";

  const { page, session } = stores();
  const { getSnackbar, configSnackbar } = getContext("snackbar");
  const { open } = getContext("simple-modal");
  const USERMODE = new Map([
    ["edit", "Edit user"],
    ["pass", "Edit Password"],
    ["del", "Delete user"],
  ]);
  const MODI = [...USERMODE.keys()];

  export let selectionUserId = null;
  export let selectedMode = "edit";

  let code;
  let user = $session.user;
  let groups = $session.groups;
  let filtered;
  let currentUser = {};
  let invalidEmail = false;
  let password = "";
  let repeatedPassword = "";
  let snackbar;
  let message;
  let avatarSrc;

  const passwordHint = "Password must have at least 8 Characters";
  const passwordErrorMesssage = "Passwords doesn't match";
  const invalidEmailMessage = "That's not a valid email address.";

  $: invalidPassword = password.length < 8;
  $: invalidRepeatedPassword = password !== repeatedPassword || invalidPassword;
  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(
      selectionUserId
    )) &&
    filtered.length &&
    filtered[0];
  $: _name = ((usr) => (usr && usr.name) || "")(
    selectedMode !== "add" ? currentUser : false
  );
  $: _email = ((usr) => (usr && usr.email) || "")(
    selectedMode !== "add" ? currentUser : false
  );
  $: _group_id = ((usr) => (usr && usr.group_id) || "")(
    selectedMode !== "add" ? currentUser : false
  );
  $: noUser = !currentUser;
  $: centered = noUser && (!selectedMode || selectedMode !== "add");
  $: email = _email;
  $: name = _name;
  $: group_id = _group_id;
  $: canChangeData =
    selectedMode === "add"
      ? name && !invalidEmail && !invalidRepeatedPassword
      : name !== _name ||
        (email !== _email && !invalidEmail) ||
        group_id != _group_id;
  $: (() => resetPassword())(selectionUserId);
  $: componentHeader = currentUser
    ? `User <strong>${currentUser.name}</strong>`
    : "Create New User";
  $: uid = currentUser.id;
  $: (async (id) => {
    if (!id) {
      avatarSrc = "";
      return;
    }

    let res = await getMedia("AVATAR", id, user, {
      width: 100,
      height: 100,
      square: 1,
    });
    if (res) avatarSrc = res;
  })(currentUser.avatar && currentUser.avatar.id);

  onMount(() => {
    snackbar = getSnackbar();
  });

  let openUploader = (type) => {
    open(
      MediaUploader,
      {
        type: "avatar",
        uid,
        options: {
          parallelUploads: 1,
          maxFiles: 1,
        },
        events: { uploadDone },
      },
      {
        transitionWindow: fly,
        transitionWindowProps: {
          y: -200,
          duration: 500,
        },
      }
    );
  };

  function uploadDone(e) {
    users.put(e.detail);
  }

  async function submit() {
    let res, data, path, action;
    snackbar.isOpen && snackbar.close();
    // resetAtts();

    switch (selectedMode) {
      case "add":
        data = { email, name, password, group_id, active: true };
        res = await api.post(`users/add`, data, user && user.token);
        break;
      case "edit":
      case "pass":
        data = password
          ? { email, name, group_id, password }
          : { email, name, group_id };
        res = await api.put(
          `users/${selectionUserId}`,
          data,
          user && user.token
        );
        break;
      case "del":
        if (
          !confirm(`${name} will be permanently removed. Confirm pressing OK`)
        )
          return;
        res = await api.del(`users/${selectionUserId}`, user && user.token);
        break;
    }

    // TODO handle network errors
    message = (res.data && res.data.message) || res.statusText;
    code = (res.data && res.data.code) || res.status;

    if (res.success) {
      switch (selectedMode) {
        case "add":
          // refresh users and jump to new user
          const resUsers = await api.get("users", user && user.token);
          if (resUsers.success) {
            users.update(resUsers.data);

            path = `users/${res.data.id}?tab=user`;
            action = "Goto new user";
            configSnackbar(message, { path, action });
            snackbar.open();
          }
          break;
        case "pass":
          resetPassword();
        case "edit":
          users.put({ ...currentUser, ...data });

          configSnackbar(message);
          snackbar.open();
          break;
        case "del":
          users.del(selectionUserId);
          selectionUserId = null;

          configSnackbar(message, "users");
          snackbar.open();
      }
    } else if (200 < code && code < 500) {
      // Sample Users are protected
      configSnackbar(message);
      snackbar.open();
    } else {
      flash.update({ type: "error", message });

      path = `login${createRedirectSlug($page)}`;
      configSnackbar(message, path);
      snackbar.open();
    }
  }

  function reset(e) {
    e.preventDefault();
    email = _email;
    name = _name;
    group_id = _group_id;
    resetPassword();
  }

  function resetPassword() {
    password = repeatedPassword = "";
  }
</script>

<style>
  form {
    position: relative;
  }
  .grid-item {
    background: var(--back-grid-item);
  }
  .user {
    grid-area: one;
    overflow: auto;
  }
  .user-items {
    display: flex;
    flex-direction: column;
  }
  .item {
    margin-bottom: 2rem;
  }
  .select-item {
    margin-bottom: 2rem;
  }
  :global(.item > label) {
    width: 100%;
  }
  .centered {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .no-selection {
    align-self: center;
  }
  .alert {
    display: table;
    margin-bottom: 1em;
  }
  .avatar-container {
    display: flex;
    justify-content: flex-end;
    position: absolute;
    right: 50px;
    top: 20px;
    z-index: 1;
  }
</style>

<div class="grid-item user" class:centered style="height: 100%;">
  <Component extended>
    <div slot="header">
      <h2>
        {@html componentHeader}
      </h2>
    </div>
    {#if selectionUserId}
      <div class="">
        <div class="avatar-container" on:click={() => openUploader('avatar')}>
          <Avatar src={avatarSrc} size="lg" />
        </div>
        <form on:submit|preventDefault={submit} method="post">
          <div class="user-items">
            {#if selectedMode !== 'add'}
              <div class="select-item">
                <Select
                  enhanced
                  bind:value={selectedMode}
                  label="Select Mode"
                  class="select-width"
                  menu$class="select-width"
                  variant="filled">
                  <Option value="" />
                  {#each MODI as mode}
                    <Option value={mode} selected={selectedMode === mode}>
                      {USERMODE.get(mode)}
                    </Option>
                  {/each}
                </Select>
              </div>
            {/if}
            {#if selectedMode === 'add' || selectedMode === 'edit'}
              <div class="item">
                <Textfield
                  bind:value={email}
                  bind:invalid={invalidEmail}
                  label=""
                  type="email"
                  updateInvalid
                  input$autocomplete="email">
                  <span slot="label"><CommonIcon
                      class="material-icons"
                      style="font-size: 1em; line-height: normal; vertical-align: middle;">
                      email
                    </CommonIcon>
                    Email</span>
                </Textfield>
                <HelperText validationMsg>{invalidEmailMessage}</HelperText>
              </div>
              <div class="item">
                <Textfield
                  withLeadingIcon
                  bind:value={name}
                  label="Name"
                  type="text"
                  input$aria-controls="helper-text-standard-b"
                  input$aria-describedby="helper-text-standard-b">
                  <TextfieldIcon class="material-icons">
                    contact_page
                  </TextfieldIcon>
                </Textfield>
                <HelperText id="helper-text-standard-b">Your Name</HelperText>
              </div>
              <div class="item">
                <Select
                  withLeadingIcon
                  bind:value={group_id}
                  label="Select Role"
                  class="select-width"
                  menu$class="select-width">
                  <span slot="icon"><SelectIcon class="material-icons">
                      contact_page
                    </SelectIcon></span>
                  <Option value="" />
                  {#each groups as group}
                    <Option value={group.id} selected={group_id === group.id}>
                      {group.name}
                    </Option>
                  {/each}
                </Select>
              </div>
            {/if}
            {#if selectedMode === 'add' || selectedMode === 'pass'}
              <div class="item">
                <Textfield
                  withLeadingIcon
                  type="password"
                  bind:invalid={invalidPassword}
                  bind:value={password}
                  label="Password"
                  input$aria-controls="helper-password"
                  input$aria-describedby="helper-password"
                  style="min-width: 250px;">
                  <TextfieldIcon class="material-icons">
                    fingerprint
                  </TextfieldIcon>
                </Textfield>
                <HelperText id="helper-password">{passwordHint}</HelperText>
              </div>
              <div class="item">
                <Textfield
                  withLeadingIcon
                  type="password"
                  disabled={invalidPassword}
                  bind:invalid={invalidRepeatedPassword}
                  class=""
                  bind:value={repeatedPassword}
                  label="Repeat Password"
                  input$aria-controls="helper-password-repeat"
                  input$aria-describedby="helper-password-repeat">
                  <TextfieldIcon class="material-icons">
                    fingerprint
                  </TextfieldIcon>
                </Textfield>
                <HelperText id="helper-password-repeat">
                  {passwordErrorMesssage}
                </HelperText>
              </div>
            {/if}
            {#if selectedMode === 'add' || selectedMode === 'edit'}
              <div class="item">
                <Button
                  disabled={!canChangeData}
                  color="primary"
                  variant="unelevated">
                  <Label>Save</Label>
                  <CommonIcon class="material-icons">save</CommonIcon>
                </Button>
                <Button
                  disabled={!canChangeData}
                  color="primary"
                  on:click={reset}
                  variant="unelevated">
                  <Label>Reset</Label>
                  <CommonIcon class="material-icons">
                    settings_backup_restore
                  </CommonIcon>
                </Button>
              </div>
            {/if}
            {#if selectedMode === 'del'}
              <div class="item">
                <div class="alert" role="alert">
                  <div
                    class="bg-red-500 text-white font-bold rounded-t px-4 py-2">
                    Caution!
                  </div>
                  <div
                    class="border border-t-0 border-red-400 rounded-b bg-red-100 px-4 py-3 text-red-700">
                    <p>
                      Deleting user
                      <strong>{name}</strong>
                      can not be undone!
                    </p>
                  </div>
                </div>
                <Button color="primary" variant="unelevated">
                  <Label>Delete</Label>
                  <CommonIcon class="material-icons">delete</CommonIcon>
                </Button>
              </div>
            {/if}
            {#if selectedMode === 'pass'}
              <div class="item">
                <Button
                  disabled={invalidRepeatedPassword}
                  color="primary"
                  variant="unelevated">
                  <Label>Change Password</Label>
                  <CommonIcon class="material-icons">fingerprint</CommonIcon>
                </Button>
              </div>
            {/if}
            {#if !selectedMode}
              <div class="no-selection">
                <Paper color="primary">
                  <Title style="color: var(--text-light)">
                    Select Edit Mode
                    {selectedMode}
                  </Title>
                </Paper>
              </div>
            {/if}
          </div>
        </form>
      </div>
    {/if}
  </Component>
</div>
