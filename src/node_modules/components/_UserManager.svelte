<script>
  import * as api from "api.js";
  import { getContext, onMount } from "svelte";
  import { stores } from "@sapper/app";
  import { users } from "../../stores/userStore";
  import { flash } from "../../stores/flashStore";
  import Textfield from "@smui/textfield";
  import HelperText from "@smui/textfield/helper-text";
  import Button, { Label } from "@smui/button";
  import { Icon as CommonIcon } from "@smui/common";
  import Select, { Option } from "@smui/select";
  import { Icon as SelectIcon } from "@smui/select/icon";
  import { Icon as TextfieldIcon } from "@smui/textfield/icon";
  import Paper, { Title, Subtitle, Content } from "@smui/paper";

  const { page, session } = stores();
  const USERMODE = new Map([
    ["edit", "Edit user"],
    ["pass", "Edit Password"],
    ["del", "Delete user"],
  ]);
  const MODI = [...USERMODE.keys()];

  export let selectionUserId = null;
  export let selectedMode = "edit";

  const {
    getSnackbar,
    getSnackbarAtts,
    setMessage,
    setAction,
    setPath,
  } = getContext("snackbarUsers");
  let code;
  let user = $session.user;
  let groups = $session.groups;
  let filtered;
  let currentUser = {};
  let invalidEmail = false;
  let password = "";
  let repeatedPassword = "";
  let snackbar;

  const passwordHint = "Password must have at least 8 Characters";
  const passwordErrorMesssage = "Passwords doesn't match";
  const invalidEmailMessage = "That's not a valid email address.";

  $: invalidPassword = password.length < 8;
  $: invalidRepeatedPassword = password !== repeatedPassword || invalidPassword;
  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(
      selectionUserId
    )) &&
    filtered.length &&
    filtered[0];
  $: _name = ((usr) => (usr && usr.name) || "")(
    selectedMode !== "add" ? currentUser : false
  );
  $: _email = ((usr) => (usr && usr.email) || "")(
    selectedMode !== "add" ? currentUser : false
  );
  $: _group_id = ((usr) => (usr && usr.group_id) || "")(
    selectedMode !== "add" ? currentUser : false
  );
  $: noUser = !currentUser;
  $: centered = noUser && (!selectedMode || selectedMode !== "add");
  $: email = _email;
  $: name = _name;
  $: group_id = _group_id;
  $: canChangeData =
    selectedMode === "add"
      ? name && !invalidEmail && !invalidRepeatedPassword
      : name !== _name ||
        (email !== _email && !invalidEmail) ||
        group_id != _group_id;
  $: (() => resetPassword())(selectionUserId);

  onMount(() => {
    snackbar = getSnackbar();
  });

  async function submit() {
    let res, data;
    snackbar.isOpen && snackbar.close();

    switch (selectedMode) {
      case "add":
        data = { email, name, password, group_id, active: true };
        res = await api.post(`users/add`, data, user && user.token);
        break;
      case "edit":
      case "pass":
        data = password
          ? { email, name, group_id, password }
          : { email, name, group_id };
        res = await api.put(
          `users/${selectionUserId}`,
          data,
          user && user.token
        );
        break;
      case "del":
        if (
          !confirm(`${name} will be permanently removed. Confirm pressing OK`)
        )
          return;
        res = await api.del(`users/${selectionUserId}`, user && user.token);
        break;
    }

    // TODO handle network errors
    let message = (res.data && res.data.message) || res.statusText;
    setMessage(message);
    code = (res.data && res.data.code) || res.status;

    if (res.success) {
      switch (selectedMode) {
        case "add":
          // refresh users and jump to new user
          const resUsers = await api.get("users", user && user.token);
          if (resUsers.success) {
            setPath(`users/${res.data.id}?tab=user`);
            setAction("Goto new user");
            users.update(resUsers.data);
            snackbar.open();
          }
          break;
        case "pass":
          resetPassword();
        case "edit":
          users.put({ ...currentUser, ...data });
          snackbar.open();
          break;
        case "del":
          users.del(selectionUserId);
          selectionUserId = null;
          snackbar.open();
      }
    } else if (200 < code && code < 500) {
      // Sample Users are protected
      snackbar.open();
    } else {
      flash.update({ type: "error", message });
      setPath(`login${redirect($page)}`);
      setMessage(`${message}. Redirecting...`);
      snackbar.open();
    }
  }

  function reset(e) {
    e.preventDefault();
    email = _email;
    name = _name;
    group_id = _group_id;
    resetPassword();
  }

  function resetPassword() {
    password = repeatedPassword = "";
  }

  function redirect(page) {
    let tab = page.query.tab;
    let path = page.path;
    let bit = "";
    return path
      ? (bit = `?redirect=${path}`) && tab
        ? bit + `&tab=${tab}`
        : bit
      : bit;
  }
</script>

<style>
  .grid-item {
    background: var(--back-grid-item);
  }
  .user {
    grid-area: one;
    overflow: auto;
  }
  .user-items {
    margin: 3rem;
    display: flex;
    flex-direction: column;
  }
  .item {
    margin-bottom: 2rem;
  }
  .select-item {
    margin-bottom: 2rem;
  }
  :global(.item > label) {
    width: 100%;
  }
  .centered {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .no-selection {
    align-self: center;
  }
  .alert {
    display: table;
    margin-bottom: 1em;
  }
</style>

<div class="grid-item user" class:centered style="height: 100%;">
  {#if selectionUserId}
    <form on:submit|preventDefault={submit} method="post">
      <div class="user-items">
        {#if selectedMode !== 'add'}
          <div class="select-item">
            <Select
              enhanced
              bind:value={selectedMode}
              label="Select Mode"
              class="select-width"
              menu$class="select-width"
              variant="filled">
              <Option value="" />
              {#each MODI as mode}
                <Option value={mode} selected={selectedMode === mode}>
                  {USERMODE.get(mode)}
                </Option>
              {/each}
            </Select>
          </div>
        {/if}
        {#if selectedMode === 'add' || selectedMode === 'edit'}
          <div class="item">
            <Textfield
              bind:value={email}
              bind:invalid={invalidEmail}
              label=""
              type="email"
              updateInvalid
              input$autocomplete="email">
              <span slot="label"><CommonIcon
                  class="material-icons"
                  style="font-size: 1em; line-height: normal; vertical-align: middle;">
                  email
                </CommonIcon>
                Email</span>
            </Textfield>
            <HelperText validationMsg>{invalidEmailMessage}</HelperText>
          </div>
          <div class="item">
            <Textfield
              withLeadingIcon
              bind:value={name}
              label="Name"
              type="text"
              input$aria-controls="helper-text-standard-b"
              input$aria-describedby="helper-text-standard-b">
              <TextfieldIcon class="material-icons">contact_page</TextfieldIcon>
            </Textfield>
            <HelperText id="helper-text-standard-b">Your Name</HelperText>
          </div>
          <div class="item">
            <Select
              withLeadingIcon
              bind:value={group_id}
              label="Select Role"
              class="select-width"
              menu$class="select-width">
              <span slot="icon"><SelectIcon class="material-icons">
                  contact_page
                </SelectIcon></span>
              <Option value="" />
              {#each groups as group}
                <Option value={group.id} selected={group_id === group.id}>
                  {group.name}
                </Option>
              {/each}
            </Select>
          </div>
        {/if}
        {#if selectedMode === 'add' || selectedMode === 'pass'}
          <div class="item">
            <Textfield
              withLeadingIcon
              type="password"
              bind:invalid={invalidPassword}
              bind:value={password}
              label="Password"
              input$aria-controls="helper-password"
              input$aria-describedby="helper-password"
              style="min-width: 250px;">
              <TextfieldIcon class="material-icons">fingerprint</TextfieldIcon>
            </Textfield>
            <HelperText id="helper-password">{passwordHint}</HelperText>
          </div>
          <div class="item">
            <Textfield
              withLeadingIcon
              type="password"
              disabled={invalidPassword}
              bind:invalid={invalidRepeatedPassword}
              class=""
              bind:value={repeatedPassword}
              label="Repeat Password"
              input$aria-controls="helper-password-repeat"
              input$aria-describedby="helper-password-repeat">
              <TextfieldIcon class="material-icons">fingerprint</TextfieldIcon>
            </Textfield>
            <HelperText id="helper-password-repeat">
              {passwordErrorMesssage}
            </HelperText>
          </div>
        {/if}
        {#if selectedMode === 'add' || selectedMode === 'edit'}
          <div class="item">
            <Button
              disabled={!canChangeData}
              color="primary"
              variant="unelevated">
              <Label>Save</Label>
              <CommonIcon class="material-icons">save</CommonIcon>
            </Button>
            <Button
              disabled={!canChangeData}
              color="primary"
              on:click={reset}
              variant="unelevated">
              <Label>Reset</Label>
              <CommonIcon class="material-icons">
                settings_backup_restore
              </CommonIcon>
            </Button>
          </div>
        {/if}
        {#if selectedMode === 'del'}
          <div class="item">
            <div class="alert" role="alert">
              <div class="bg-red-500 text-white font-bold rounded-t px-4 py-2">
                Caution!
              </div>
              <div
                class="border border-t-0 border-red-400 rounded-b bg-red-100 px-4 py-3 text-red-700">
                <p>Deleting user <strong>{name}</strong> can not be undone!</p>
              </div>
            </div>
            <Button color="primary" variant="unelevated">
              <Label>Delete</Label>
              <CommonIcon class="material-icons">delete</CommonIcon>
            </Button>
          </div>
        {/if}
        {#if selectedMode === 'pass'}
          <div class="item">
            <Button
              disabled={invalidRepeatedPassword}
              color="primary"
              variant="unelevated">
              <Label>Change Password</Label>
              <CommonIcon class="material-icons">fingerprint</CommonIcon>
            </Button>
          </div>
        {/if}
        {#if !selectedMode}
          <div class="no-selection">
            <Paper color="primary">
              <Title style="color: var(--text-light)">
                Select Edit Mode
                {selectedMode}
              </Title>
            </Paper>
          </div>
        {/if}
      </div>
    </form>
  {:else}No User Selected{/if}
</div>
