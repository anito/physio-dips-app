<script>
  import * as api from "api.js";
  import { stores } from "@sapper/app";
  import { users } from "../../stores/userStore";
  import Textfield from "@smui/textfield";
  import HelperText from "@smui/textfield/helper-text/index";
  import Button, { Label } from "@smui/button";
  import { Icon as CommonIcon } from "@smui/common";
  import Icon from "@smui/textfield/icon/index";
  import Select, { Option } from "@smui/select";
  import Snackbar, { Actions, Label as SnackbarLabel } from "@smui/snackbar";
  import Paper, { Title, Subtitle, Content } from "@smui/paper";

  export let selectionUserId;

  const { session } = stores();
  const USER = "Edit User";
  const PASSWORD = "Change Password";
  const MODI = [USER, PASSWORD];

  let snackbar;
  let errors;
  let message;
  let user = $session.user;
  let filtered;
  let currentUser = {};
  let name = "";
  let email = "";
  let password = "";
  let repeatedPassword = "";
  let selectedMode;

  $: invalidPassword = password.length < 8;
  $: invalidRepeatedPassword = password !== repeatedPassword;
  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(
      selectionUserId
    )) &&
    filtered.length &&
    filtered[0];
  $: (() => (name = "") || (email = "") || (password = ""))(selectionUserId);
  $: ((usr) => name || (name = usr.name))(currentUser);
  $: ((usr) => email || (email = usr.email))(currentUser);
  $: noUser = !currentUser;
  $: userDataChanged = name !== currentUser.name || email !== currentUser.email;

  async function submit() {
    let data = { email, name };

    const res = await api.put(
      `users/${selectionUserId}`,
      data,
      user && user.token
    );

    // TODO handle network errors
    errors = res.errors;
    message = res.message || res.data.message;

    if (res && res.success) {
      users.put({ ...currentUser, ...data });
      password = repeatedPassword = "";
    } else {
      snackbar.open();
    }
  }

  function reset() {
    email = currentUser.email;
    name = currentUser.name;
  }

  function handleClosed() {
    //
  }
</script>

<style>
  .grid-item {
    background: var(--back-grid-item);
  }
  .user {
    grid-area: one;
    overflow: auto;
  }
  .user-items {
    margin: 3rem;
    display: flex;
    flex-direction: column;
  }
  .item {
    margin-bottom: 2rem;
  }
  .select-item {
    margin-bottom: 2rem;
  }
  :global(.item > label) {
    width: 100%;
  }
  .no-user {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .no-selection {
    align-self: center;
  }
</style>

<div class="grid-item user" class:no-user={noUser}>
  {#if selectionUserId}
    <form on:submit|preventDefault={submit} method="post">
      <div class="user-items">
        <div class="select-item">
          <Select
            enhanced
            bind:value={selectedMode}
            label="Select Mode"
            class="select-width"
            menu$class="select-width"
            variant="filled">
            <Option value="" />
            {#each MODI as mode}
              <Option value={mode} selected={selectedMode === mode}>
                {mode}
              </Option>
            {/each}
          </Select>
        </div>
        {#if selectedMode === USER}
          <div class="item">
            <Textfield
              bind:value={email}
              label=""
              type="email"
              updateInvalid
              input$autocomplete="email">
              <span slot="label"><CommonIcon
                  class="material-icons"
                  style="font-size: 1em; line-height: normal; vertical-align: middle;">
                  email
                </CommonIcon>
                Email</span>
            </Textfield>
            <HelperText validationMsg>
              That's not a valid email address.
            </HelperText>
          </div>
          <div class="item">
            <Textfield bind:value={name} label="Name" type="text" />
          </div>
          <div class="item">
            <Button
              disabled={!userDataChanged}
              color="primary"
              variant="unelevated">
              <Label>Save</Label>
              <CommonIcon class="material-icons">save</CommonIcon>
            </Button>
            <Button
              disabled={!userDataChanged}
              color="primary"
              on:click={() => reset()}
              variant="unelevated">
              <Label>Reset</Label>
              <CommonIcon class="material-icons">
                settings_backup_restore
              </CommonIcon>
            </Button>
          </div>
        {:else if selectedMode === PASSWORD}
          <div class="item">
            <Textfield
              type="password"
              bind:invalid={invalidPassword}
              bind:value={password}
              label="Password"
              input$aria-controls="helper-password"
              input$aria-describedby="helper-password"
              style="min-width: 250px;" />
            <HelperText id="helper-password">
              Password must have at least 8 Characters
            </HelperText>
          </div>
          <div class="item">
            <Textfield
              type="password"
              disabled={invalidPassword}
              bind:invalid={invalidRepeatedPassword}
              class=""
              bind:value={repeatedPassword}
              label="Repeat Password"
              input$aria-controls="helper-password-repeat"
              input$aria-describedby="helper-password-repeat" />
            <HelperText id="helper-password-repeat">
              Password doesn't match
            </HelperText>
          </div>
          <div class="item">
            <Button
              disabled={!password || password !== repeatedPassword}
              color="primary"
              variant="unelevated">
              <Label>Change Password</Label>
              <CommonIcon class="material-icons">fingerprint</CommonIcon>
            </Button>
          </div>
        {:else}
          <div class="no-selection">
            <Paper color="primary">
              <Title style="color: var(--text-light)">Select Edit Mode</Title>
            </Paper>
          </div>
        {/if}
      </div>
    </form>
  {:else}No User Selected{/if}
</div>

<Snackbar
  timeoutMs="4000"
  variant="stacked"
  bind:this={snackbar}
  labelText={message}
  on:MDCSnackbar:closed={handleClosed}>
  <SnackbarLabel />
</Snackbar>
