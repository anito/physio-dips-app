<script>
  import { createEventDispatcher } from "svelte";
  import Uploader from "./_Uploader.svelte";
  import { Header } from "@sveltejs/site-kit";
  import { images } from "../../stores/imageStore";
  import { avatars } from "../../stores/avatarStore";
  import { videos } from "../../stores/videoStore";
  import { currentVideo } from "../../stores/currentVideoStore";
  import { videoEmitter } from "../../stores/videoEmitter";

  export { className as class };
  export let type = "";
  export let id = "";
  export let options;

  const dispatch = createEventDispatcher();

  let className = "";
  let count = 0;

  $: path = `${type.toLowerCase()}s`;
  $: fileTypes = (type === "avatar" && "image") || type;
  $: acceptedFiles = !acceptedFiles && `${fileTypes}/*`;
  $: options = { ...options, acceptedFiles, path };

  function onAddedfile(file) {
    ++count;
  }
  function onRemovedfile(file) {
    --count;
  }

  function onSuccess(e) {
    if (options["uploadMultiple"]) return;
    handleUpload(e.detail.data);
  }

  function onSuccessmultiple(e) {
    handleUpload(e.detail.data);
  }

  function handleUpload(data) {
    console.log(data);
    (type === "image" && images.add(data)) ||
      (type === "avatar" && avatars.add(data)) ||
      (type === "video" && videos.add(data));

    let video;
    if (!(video = $currentVideo)) return;

    // take the last element for our poster
    let image_id = data.slice(-1)[0].id;
    video.image_id = image_id;

    videoEmitter.dispatch({
      method: "put",
      data: video,
    });
  }
</script>

<style>
  :global(.upload-header) {
    text-transform: capitalize;
  }
  .subheader {
    font-size: 0.8rem;
  }
</style>

<div class="uploader-wrapper {className}">
  <Header h="5" mdc class="upload-header">{`${type} Uploader`}</Header>
  <div class="subheader">
    <span>Queue:{count}</span>
    <span>Max:{options.maxFiles}</span>
  </div>
  <Uploader
    on:Uploader:successmultiple={onSuccessmultiple}
    on:Uploader:success={onSuccess}
    on:Uploader:addedfile={onAddedfile}
    on:Uploader:removedfile={onRemovedfile}
    {...options}
    {id} />
</div>
