<script>
  import "./meta.scss";
  import UserGraphic from "./_UserGraphic.svelte";
  import {
    Item,
    Meta,
    Separator,
    Subheader,
    Text,
    PrimaryText,
    SecondaryText,
    Graphic,
  } from "@smui/list";

  export let selectionUserId = null;
  export let user;
  export { className as class };

  const tooltipWarnings = new Set();
  const expiredTooltip = "Token expired";
  const tokenTooltip = "No Token";
  const activeTooltip = "User not active";

  let className = "";
  let expires;
  let hasExpired;

  $: expires = user.expires;
  $: active = user.active;
  $: token = user.token;
  $: hasExpired = (expires && expires * 1000 < +new Date().getTime()) || false;
  $: warnings = () => {
    (hasExpired && tooltipWarnings.add(expiredTooltip)) ||
      tooltipWarnings.delete(expiredTooltip);
    (!token && tooltipWarnings.add(tokenTooltip)) ||
      tooltipWarnings.delete(tokenTooltip);
    (!active && tooltipWarnings.add(activeTooltip)) ||
      tooltipWarnings.delete(activeTooltip);
    return tooltipWarnings;
  };
</script>

<style>
</style>

<Item class={className} selected={selectionUserId == user.id}>
  <UserGraphic width="40" height="40" {user} border />
  <Text>
    <PrimaryText>{user.name}</PrimaryText>
    <SecondaryText>{user.email}</SecondaryText>
  </Text>
  {#if user.protected}
    <Meta class="material-icons" title="User is readonly">lock</Meta>
  {/if}
  <div class="meta-list-items flex flex-1 flex-col">
    <div
      class="meta-item ml-auto opacity-25"
      class:meta-warning={hasExpired || !token}
      class:opacity-25={!token}>
      <Meta
        class="material-icons"
        title={hasExpired ? 'Token expired' : !token ? 'No Token' : 'Token is valid'}>
        {hasExpired || !token ? 'link_off' : 'link'}
      </Meta>
    </div>
    {#if warnings().size}
      <div class="meta-item meta-warning ml-auto">
        <Meta class="material-icons" title={Array.from(warnings()).join(' | ')}>
          announcement
        </Meta>
      </div>
    {/if}
  </div>
</Item>
