<script>
  import * as api from "api.js";
  import { images } from "../../stores/imageStore";
  import { urls } from "../../stores/urlStore";
  import MediaImagePreview from "./_MediaImagePreview.svelte";
  import Card, {
    Content,
    PrimaryAction,
    Actions,
    ActionButtons,
    ActionIcons,
  } from "@smui/card";
  import Button, { Label } from "@smui/button";
  import IconButton, { Icon } from "@smui/icon-button";
  import Menu from "@smui/menu";
  import List, {
    Item,
    Separator,
    Text,
    PrimaryText,
    SecondaryText,
    Graphic,
  } from "@smui/list";

  export let image;
  export let user;
  export { className as class };

  let className = "";
  let menuPoster;

  async function deletePoster() {
    const id = image.id;
    const res = await api.del(`images/${id}`, user && user.token);

    if (res.success) {
      urls.del(id);
      // at this point associated videos are not updated yet
      // however we fetch a fresh set on preload when changing to video page
      images.del(id);
    }
  }
</script>

<style>
</style>

<Card class="flex content-between {className}" style="width: var(--poster-w);">
  <PrimaryAction>
    <MediaImagePreview media={image} {user} />
  </PrimaryAction>
  <div class="flex flex-col justify-end" style="flex:1 0 auto">
    <Actions>
      <ActionButtons>
        <Button color="primary" on:click={() => menuPoster.setOpen(true)}>
          <Label>Delete</Label>
          <Icon class="material-icons">delete</Icon>
        </Button>
      </ActionButtons>
      <ActionIcons style="position: relative;">
        <IconButton
          class="material-icons"
          on:click={() => menuPoster.setOpen(true)}
          toggle
          aria-label="Add to favorites"
          title="Add to favorites">
          more_vert
        </IconButton>
        <Menu bind:this={menuPoster}>
          <List>
            <Item class="text-red-700" on:SMUI:action={() => deletePoster()}>
              <Text>Delete Poster</Text>
            </Item>
          </List>
        </Menu>
      </ActionIcons>
    </Actions>
  </div>
</Card>
