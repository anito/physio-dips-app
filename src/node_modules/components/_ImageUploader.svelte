<script>
  import { get } from "svelte/store";
  import { createEventDispatcher } from "svelte";
  import { images } from "../../stores/imageStore";
  import Uploader from "./_Uploader.svelte";
  import { Header } from "@sveltejs/site-kit";
  import { videos } from "../../stores/videoStore";
  import { videoEmitter } from "../../stores/videoEmitter";
  import { currentVideo } from "../../stores/currentVideoStore";

  let dispatch = createEventDispatcher();
  let component;
  let className = "";
  let options = {
    acceptedFiles: "image/*",
    paramName: "Image",
    uploadMultiple: false,
    parallelUploads: 12,
    maxFiles: get(currentVideo) ? 1 : 12,
    path: "images",
  };
  let count = 0;

  export { className as class };

  function onAddedfile(image) {
    ++count;
  }
  function onRemovedfile(image) {
    --count;
  }

  function onSuccess(e) {
    if (options["uploadMultiple"]) return;
    let uploads = e.detail.data;
    handleUpload(uploads);
  }
  function onSuccessmultiple(e) {
    let uploads = e.detail.data;
    handleUpload(uploads);
  }
  function handleUpload(uploads) {
    let video;

    images.add(uploads);

    // do we have a associated video?
    if ((video = get(currentVideo))) {
      // take the last element for poster
      let image_id = uploads.slice(-1)[0].id;

      // only required for cakes customized finder methods
      // eg "findWithImages" which return assoziated models
      // video.image = null;
      video.image_id = image_id;

      videoEmitter.dispatch({
        method: "put",
        data: video,
      });
    }
  }
</script>

<style>
  .subheader {
    font-size: 0.8rem;
  }
</style>

<div class="uploader-wrapper {className}" bind:this={component}>
  <Header h="5" mdc>
    Image Uploader
    <div class="subheader">
      <span>Queue:{count}</span>
      <span>Max:{options.maxFiles}</span>
    </div>
  </Header>
  <Uploader
    on:Uploader:successmultiple={onSuccessmultiple}
    on:Uploader:success={onSuccess}
    on:Uploader:addedfile={onAddedfile}
    on:Uploader:removedfile={onRemovedfile}
    {...options} />
</div>
