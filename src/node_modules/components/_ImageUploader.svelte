<script context="module">
  let count = 0;
</script>

<script>
  import { createEventDispatcher } from "svelte";
  import { images } from "../../stores/imageStore";
  import { avatars } from "../../stores/avatarStore";
  import Uploader from "components/_Uploader.svelte";
  import { Header } from "@sveltejs/site-kit";
  import { videoEmitter } from "../../stores/videoEmitter";
  import { currentVideo } from "../../stores/currentVideoStore";

  export { className as class };
  export let type;
  export let options;

  const dispatch = createEventDispatcher();

  $: serverParams = {
    path: type.toLowerCase(),
    acceptedFiles: `${type}/*`,
  };

  let component;
  let className = "";
  // let forVideo = get(currentVideo); // do we have a associated video?
  let options_ = {
    acceptedFiles: "image/*",
    paramName: type,
    uploadMultiple: false,
    parallelUploads: 12,
    maxFiles: type.toLowerCase() === "image" ? ($currentVideo ? 1 : 12) : 1,
    path: type === "Image" ? "images" : "avatars", // part of the path to the server
  };

  function onAddedfile(image) {
    ++count;
  }
  function onRemovedfile(image) {
    --count;
  }

  function onSuccess(e) {
    if (options["uploadMultiple"]) return;
    // handleUpload(e.detail.data);
    dispatch("Uploader:success");
  }
  function onSuccessmultiple(e) {
    // handleUpload(e.detail.data);
    dispatch("Uploader:successmultiple");
  }
  function handleUpload(data) {
    type === "Image" ? images.add(data) : avatars.add(data);

    if (!forVideo) return;

    // take the last element for our poster
    let image_id = data.slice(-1)[0].id;

    // only required for cakes customized finder methods
    // eg "findWithImages" which return assoziated models
    // video.image = null;
    forVideo.image_id = image_id;

    videoEmitter.dispatch({
      method: "put",
      data: forVideo,
    });
  }
</script>

<style>
  .subheader {
    font-size: 0.8rem;
  }
</style>

<div class="uploader-wrapper {className}" bind:this={component}>
  <Header h="5" mdc>
    {`${type} Uploader`}
    <div class="subheader">
      <span>Queue:{count}</span>
      <span>Max:{options.maxFiles}</span>
    </div>
  </Header>
  <Uploader
    on:Uploader:successmultiple={onSuccessmultiple}
    on:Uploader:success={onSuccess}
    on:Uploader:addedfile={onAddedfile}
    on:Uploader:removedfile={onRemovedfile}
    {...options} />
</div>
