<script>
  import { stores } from "@sapper/app";
  import { createEventDispatcher } from "svelte";
  import {
    Item,
    Graphic,
    Meta,
    Separator,
    Subheader,
    Text,
    PrimaryText,
    SecondaryText,
  } from "@smui/list";
  import { getMedia, toLocalDate } from "utils";
  import { parseISO } from "date-fns";
  import { users } from "../../../stores/userStore";

  export let video;
  export let selectionUserId = null;
  export let selectionVideoId = null;
  export { className as class };
  export let emptyDateText = "";
  export let emphasizeEmptyDate = false;

  const { session } = stores();
  const base = "https://via.placeholder.com/40x40.png?text=";

  let dispatch = createEventDispatcher();
  let className = "";
  let src;
  let selectedVideo;
  let startDate;
  let endDate;
  let filtered;
  let user = $session.user;
  let dateFormat = "dd MMM yyyy";

  $: video && backgroundImageSrc(video);
  $: unmanagable = !user || !selectionUserId;
  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(
      selectionUserId
    )) &&
    filtered.length &&
    filtered[0];
  // $: joinData =
  //   (_video = currentUser.videos.find((v) => v.id === video.id)) &&
  //   _video._joinData;
  $: joinData =
    (selectedVideo = currentUser.videos.find(
      (v) => v.id === selectionVideoId
    )) && selectedVideo._joinData;
  $: startDate =
    (joinData && joinData.start && parseISO(joinData.start)) ||
    startOfDay(new Date());
  $: endDate =
    (joinData && joinData.end && parseISO(joinData.end)) || startDate;
  $: emptyDate = () => !(joinData && joinData.start && joinData.end);
  $: readout = () => getReadout(joinData);

  function getReadout(data) {
    if (emptyDate()) return emptyDateText.toString();
    return `${toLocalDate(data.start)} - ${toLocalDate(data.end)}`;
  }

  async function backgroundImageSrc(video) {
    let initials;

    if (video.title) {
      initials = video.title
        .split(" ")
        .map((val) => val.substring(0, 1))
        .join("");
      src = `${base}${initials}`;
    } else {
      src = base;
    }

    const res = await getPosterUrl(video.image_id);
    if (res) src = res;
  }

  async function getPosterUrl(id) {
    if (id) {
      // options.square: 0 => intelligent resize (keep ratio) |Â 1 => force resize | 2 => no resize (original)
      const res = await getMedia("IMAGE", id, user, {
        width: 40,
        height: 40,
        square: 1,
      });
      if (res) return res;
    }
  }
</script>

<style>
  .item {
    position: relative;
    display: block;
  }
  :global(.user-video) .date {
    color: var(--text-light);
    padding: 3px 6px;
    line-height: 3em;
    font-size: 0.7rem;
  }
  .info-date {
    background: rgb(27, 85, 27);
  }
  .alert-empty {
    background: var(--error);
  }
  .action-buttons :global(input[type="checkbox"]),
  .action-buttons :global([class*="-action-button"]) {
    position: absolute;
    top: 0;
    bottom: 0;
    margin: auto 3px;
  }
  .action-buttons > :global(*):nth-child(1) {
    right: 0;
  }
  .action-buttons > :global(*):nth-child(2) {
    right: 64px;
  }
</style>

<div class="item {className}">
  <Item
    disabled={unmanagable}
    on:SMUI:action={() => dispatch('videoSelected', video)}
    selected={selectionVideoId == video.id}>
    <Graphic style="background-image: url({src});" />
    <Text>
      <PrimaryText>
        <span class="opacity-25" class:opacity-25={!video.title}>
          {video.title || 'No Title'}
        </span>
      </PrimaryText>
      <SecondaryText>
        <span
          class="date"
          class:info-date={!emptyDate()}
          class:alert-empty={emptyDate() && emphasizeEmptyDate}>
          {readout(joinData)}
        </span>
      </SecondaryText>
    </Text>
  </Item>
  <div class="action-buttons">
    <slot published={!emptyDate()} />
  </div>
</div>
