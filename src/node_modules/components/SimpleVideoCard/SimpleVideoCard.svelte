
<script>
	import { stores } from '@sapper/app';
	import { createEventDispatcher } from 'svelte';
	import { Item, Graphic, Meta, Separator, Subheader, Text, PrimaryText, SecondaryText } from '@smui/list';
	import { getMedia } from 'utils';
	
	export let video;
	export let selectionUserId = null;
	export let selectionVideoId = null;
	export { className as class }
	export let checked = false;
	export let singleSelection = false;

	const { session } = stores();	
	const base = 'https://via.placeholder.com/40x40.png?text=';

	let dispatch = createEventDispatcher();
	let className = '';
	let src;
	let user = $session.user;

	$: isChecked = singleSelection ? selectionVideoId === video.id : checked;
	$: video && backgroundImageSrc(video);
	$: unmanagable = !user || !selectionUserId;

	async function backgroundImageSrc(video) {
		
		let initials;

		if(video.title) {
			initials = video.title.split(' ').map(val => val.substring(0, 1)).join('');
			src = `${base}${initials}`
		} else {
			src = base;
		}

		const res = await getPosterUrl(video.image_id);
		if(res) src = res;
	}

	async function getPosterUrl(id) {

		if(id) {
			// options.square: 0 => intelligent resize (keep ratio) | 1 => force resize | 2 => no resize (original)
			const res = await getMedia('IMAGE', id, user, {width:40, height:40, square: 1});
			if(res) return res;
        }
	}

	function changeHandler(e) {
		setTimeout( () => {
			dispatch('videoSelected', video);
			selectionVideoId = video.id;
		}, !singleSelection  && 300)
	}

</script>

<style>
	label {
		position: relative;
		display: block;
	}
	input {
		position: absolute;
		right: 15px;
		top: 0;
		bottom: 0;
		margin: auto 0;
		width: 100px;
	}

</style>

<label class="{className}">
	<div class="item">
		<Item disabled={unmanagable} selected={selectionVideoId == video.id}>
			<Graphic style="background-image: url({src});" />
			<Text>
				<PrimaryText>
					<span class="opacity-25" class:opacity-25={!video.title}>
						{video.title || 'No Title'}
					</span>
				</PrimaryText>
				<SecondaryText>
					<span class="opacity-25" class:opacity-25={!video.id}>
						{video.id}
					</span>
				</SecondaryText>
			</Text>
		</Item>
	</div>
	<input disabled={unmanagable} checked={isChecked} type=checkbox on:change="{() => changeHandler(video)}">
</label>