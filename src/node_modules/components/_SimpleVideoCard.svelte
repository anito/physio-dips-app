<script>
	import { stores } from '@sapper/app';
	import { createEventDispatcher } from 'svelte';
	import { Item, Graphic, Meta, Separator, Subheader, Text, PrimaryText, SecondaryText } from '@smui/list';
	import { getMedia } from 'utils';
	
	export let video;
	export let checkbox;
	export let selectionUserId = false;
	export { className as class }
	export let check = false;

	const { session } = stores();	
	const base = 'https://via.placeholder.com/40x40.png?text=';

	let dispatch = createEventDispatcher();
	let selectionVideoId;
	let className;
	let src;

	$: user = $session.user;
	$: video && backgroundImageSrc(video);
	$: unmanagable = !user || !selectionUserId || !checkbox;

	async function backgroundImageSrc(video) {
		
		let initials;
		const res = await getPosterUrl(video.image_id);

		if(video.title) {
			initials = video.title.split(' ').map(val => val.substring(0, 1)).join('');
			src = `${base}${initials}`
		} else {
			src = base;
		}
		if(res) src = res;
	}

	async function getPosterUrl(id) {

		if(id) {
			// options.square: 0 => intelligent resize (keep ratio) | 1 => force resize | 2 => no resize (original)
			const res = await getMedia('IMAGE', id, user, {width:40, height:40, square: 1});
			if(res) return res;
        }
	}

	function changeHandler(e) {
		dispatch('videoSelected', video);
	}
</script>

<style>
	label {
		position: relative;
		display: block;
	}
	input {
		position: absolute;
		right: 15px;
		top: 0;
		bottom: 0;
		margin: auto 0;
		width: 100px;
	}
	input.unmanagable {
		display: none;
	}

</style>

<label class="{className}">
	<div class="item">
		<Item disabled={unmanagable} on:SMUI:action={() => false} selected={selectionVideoId === video.id}>
			<Graphic style="background-image: url({src});" />
			<Text>
				<PrimaryText>
					<span class="opacity-25" class:opacity-25={!video.title}>
						{video.title || 'No Title'}
					</span>
				</PrimaryText>
				<SecondaryText>
					<span class="opacity-25" class:opacity-25={!video.id}>
						{video.id}
					</span>
				</SecondaryText>
			</Text>
		</Item>
	</div>
	<input class:unmanagable checked={check} type=checkbox on:change={ e => changeHandler(e)} >
</label>