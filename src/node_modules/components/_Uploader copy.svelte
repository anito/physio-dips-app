<script>
  import { stores } from "@sapper/app";
  import { onMount, createEventDispatcher, getContext } from "svelte";
  import PreviewTemplate from "./_PreviewTemplate.svelte";
  import Button, { Label, Icon } from "@smui/button";
  import LinearProgress from "@smui/linear-progress";
  import { post } from "utils";
  import { base } from "api";
  import { slide } from "svelte/transition";
  import { quintOut } from "svelte/easing";
  import { Dropzone } from "@sveltejs/site-kit";
  import { id } from "date-fns/locale";

  export { className as class };
  export let path;
  export let acceptedFiles;
  export let uploadMultiple = false;
  export let parallelUploads = 2;
  export let maxFiles = 2;
  export let method = "post";
  export let params = new Map();
  export let uid;

  const { close } = getContext("simple-modal");
  const dispatch = createEventDispatcher();
  const { session } = stores();

  let component;
  let dropzone;
  let className = "";
  let progress = 0;
  let preview;
  let template;
  let options;
  let count = 0;

  $: hasFiles = !!count;
  $: closed = !hasFiles;
  $: if (!hasFiles) progress = 0; // reset progress when removing last file
  $: console.log(params);

  let html = (el) => {
    let child = el.childNodes[0];
    template = el.removeChild(child).outerHTML;
  };

  let submit = function (e) {
    e.preventDefault();
    dropzone.processQueue();
  };
  let init = function () {
    dropzone = this;

    // Events
    this.on("successmultiple", (e, res) => {
      dispatch("Uploader:successmultiple", res);
    });
    this.on("success", (e, res) => {
      dispatch("Uploader:success", res);
    });
    this.on("addedfile", (file) => {
      ++count;
      dispatch("Uploader:addedfile", file);
    });
    this.on("removedfile", (file) => {
      --count;
      dispatch("Uploader:removedfile", file);
    });
    this.on("totaluploadprogress", (val) => {
      dispatch("Uploader:totaluploadprogress", val);
      progress = val / 100;
    });
    this.on("complete", (file) => {
      dropzone.removeFile(file);
      close();
    });
    this.on("maxfilesreached", (files) => {});
  };

  onMount(async () => {
    options = {
      url: `${base}/${path}?token=${$session.user.token}`,
      method,
      timeout: 180 * 1000, // 3min
      paramName: "Files",
      uploadMultiple,
      maxFiles,
      params,
      autoProcessQueue: false,
      parallelUploads,
      withCredentials: true,
      thumbnailWidth: 80,
      thumbnailHeight: 80,
      clickable: true,
      acceptedFiles,
      maxFilesize: 256,
      previewsContainer: preview,
      previewTemplate: template,
      init,
    };
  });
</script>

<style>
  form {
    width: 100%;
    height: 100%;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .dz-message {
    z-index: -1;
    position: relative;
  }
  .hasFiles {
    display: none;
  }
  .files-table {
    position: absolute;
    top: 0;
    width: 100%;
    height: auto;
    display: flex;
    flex-flow: row wrap;
    justify-content: start;
    align-items: start;
  }
  :global(.dropzone) {
    width: 100%;
    margin-bottom: 3em;
  }
  :global(.btn-upload) {
    position: absolute;
    bottom: -60px;
  }
  .progressbar {
    position: absolute;
    bottom: -90px;
  }
</style>

<div class="content {className}" bind:this={component}>
  <Dropzone
    bind:this={dropzone}
    dropzoneClass="dropzone"
    hoveringClass="hoveringClass"
    dropzoneEvents={{ init }}
    {options}
    let:id>
    <form on:submit|preventDefault={submit} {id}>
      <p class:hasFiles class="fileAdded dz-message {id}">
        Drop your files or click to addd
      </p>
      <input hidden name="uid" type="hidden" value={uid} />
      <Button
        disabled={!hasFiles}
        variant="raised"
        color="primary"
        class="w-full btn-upload">
        <Label>Upload</Label>
        <Icon class="material-icons">cloud_upload</Icon>
        <LinearProgress class="progressbar" {progress} {closed} />
      </Button>
    </form>
  </Dropzone>
  <div use:html class="files-table files" bind:this={preview}>
    <PreviewTemplate />
  </div>
</div>
